<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบข้อสอบปลายภาค ชีววิทยา 6</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #7dd3fc 100%); }
    .card-shadow { box-shadow: 0 10px 40px rgba(14, 165, 233, 0.15); }
    .btn-primary { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); }
    .question-card { transition: all 0.3s ease; }
    .question-card:hover { transform: translateY(-2px); }
    .tab-active { border-bottom: 3px solid #0ea5e9; color: #0ea5e9; }
    @keyframes pulse-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .warning-pulse { animation: pulse-warning 1s infinite; }
    .sidebar-item { transition: all 0.2s ease; }
    .sidebar-item:hover { background: rgba(14, 165, 233, 0.1); }
    .sidebar-item.active { background: rgba(14, 165, 233, 0.2); border-left: 4px solid #0ea5e9; }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full gradient-bg">
  <div id="app" class="h-full overflow-auto"><!-- Header -->
   <header class="bg-white/90 backdrop-blur-sm shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
     <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-sky-400 to-sky-600 rounded-xl flex items-center justify-center">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg>
      </div>
      <div>
       <h1 id="header-title" class="text-lg md:text-xl font-bold text-sky-800">ระบบข้อสอบปลายภาค วิชา ชีววิทยา 6</h1>
       <p class="text-xs text-sky-600">พัฒนาโดย ว่าที่ร้อยตรีอานนท์ เมืองแก้ว @2025</p>
      </div>
     </div>
     <div class="flex items-center gap-3">
      <div id="timer-display" class="hidden bg-sky-100 px-4 py-2 rounded-lg"><span class="text-sky-800 font-semibold" id="timer-text">00:00:00</span>
      </div><button id="admin-btn" onclick="showAdminLogin()" class="p-2 hover:bg-sky-100 rounded-full transition-colors">
       <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
       </svg></button>
     </div>
    </div>
   </header><!-- Student Registration Page -->
   <div id="registration-page" class="max-w-lg mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl card-shadow p-6 md:p-8">
     <div class="text-center mb-6">
      <div class="w-20 h-20 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center mx-auto mb-4">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
       </svg>
      </div>
      <h2 class="text-2xl font-bold text-sky-800">ลงทะเบียนสอบ</h2>
      <p id="exam-topic-display" class="text-sky-600 mt-1">หัวข้อ: ระบบนิเวศและสิ่งแวดล้อม</p>
     </div>
     <form id="registration-form" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-สกุล</label> <input type="text" id="student-name" required class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition-all" placeholder="กรอกชื่อ-สกุล">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">เลขที่</label> <input type="number" id="student-number" required min="1" class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition-all" placeholder="กรอกเลขที่">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">ห้อง</label> <select id="student-classroom" required class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition-all"> <option value="">เลือกห้อง</option> <option value="ม.6/6">ม.6/6</option> <option value="ม.6/7">ม.6/7</option> <option value="ม.6/8">ม.6/8</option> <option value="ม.6/9">ม.6/9</option> <option value="ม.6/10">ม.6/10</option> <option value="ม.6/11">ม.6/11</option> </select>
      </div><button type="submit" class="w-full btn-primary text-white font-semibold py-3 rounded-xl transition-all hover:shadow-lg"> เริ่มทำข้อสอบ </button>
     </form>
     <div class="mt-6 p-4 bg-amber-50 rounded-xl border border-amber-200">
      <h4 class="font-semibold text-amber-800 flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg> ข้อควรระวัง</h4>
      <ul class="text-sm text-amber-700 mt-2 space-y-1">
       <li>• ห้ามย่อหน้าจอ พับหน้าจอ หรือเปิดหน้าต่างอื่น</li>
       <li>• หากทุจริต 3 ครั้ง จะถูกยุติการสอบทันที</li>
       <li>• ข้อสอบทั้งหมด 40 ข้อ</li>
      </ul>
     </div>
    </div>
   </div><!-- Exam Page -->
   <div id="exam-page" class="hidden max-w-4xl mx-auto px-4 py-6">
    <div class="bg-white rounded-2xl card-shadow p-4 md:p-6 mb-4">
     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
      <div>
       <h3 class="text-lg font-bold text-sky-800" id="student-info-display"></h3>
       <p class="text-sky-600 text-sm">ข้อสอบ: <span id="current-question-num">1</span>/40</p>
      </div>
      <div id="warning-display" class="hidden bg-red-100 px-4 py-2 rounded-lg warning-pulse"><span class="text-red-600 font-semibold">⚠️ คำเตือน: <span id="warning-count">0</span>/3</span>
      </div>
     </div><!-- Question Navigation -->
     <div class="flex flex-wrap gap-2 mb-4 p-3 bg-sky-50 rounded-xl max-h-32 overflow-y-auto">
      <div id="question-nav"></div>
     </div>
    </div><!-- Question Content -->
    <div id="question-container" class="bg-white rounded-2xl card-shadow p-4 md:p-6"><!-- Question will be rendered here -->
    </div><!-- Navigation Buttons -->
    <div class="flex justify-between mt-4 gap-4"><button onclick="prevQuestion()" class="flex-1 bg-white border-2 border-sky-400 text-sky-600 font-semibold py-3 rounded-xl hover:bg-sky-50 transition-all"> ← ข้อก่อนหน้า </button> <button onclick="nextQuestion()" class="flex-1 btn-primary text-white font-semibold py-3 rounded-xl transition-all hover:shadow-lg"> ข้อถัดไป → </button>
    </div><button onclick="submitExam()" class="w-full mt-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all"> ส่งข้อสอบ </button>
   </div><!-- Result Page -->
   <div id="result-page" class="hidden max-w-lg mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl card-shadow p-6 md:p-8 text-center">
     <div id="result-icon" class="w-24 h-24 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
     </div>
     <h2 class="text-2xl font-bold text-gray-800 mb-2">ส่งข้อสอบเรียบร้อย!</h2>
     <p id="result-name" class="text-gray-600 mb-4"></p>
     <div class="bg-sky-50 rounded-xl p-6 mb-4">
      <p class="text-4xl font-bold text-sky-600" id="result-score">0/40</p>
      <p class="text-sky-800 mt-2">คะแนนที่ได้</p>
     </div>
     <p id="result-time" class="text-gray-500"></p>
    </div>
   </div><!-- Admin Page -->
   <div id="admin-page" class="hidden">
    <div class="flex h-full"><!-- Sidebar -->
     <div class="w-64 bg-white shadow-lg fixed h-full overflow-y-auto hidden md:block">
      <div class="p-4 border-b">
       <h3 class="font-bold text-sky-800">แอดมินระบบ</h3>
       <p id="admin-email-display" class="text-sm text-gray-500 truncate"></p>
      </div>
      <nav class="p-2"><button onclick="showAdminTab('questions')" class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-tab="questions">
        <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> จัดการข้อสอบ </button> <button onclick="showAdminTab('results')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-tab="results">
        <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg> ผลสอบ </button> <button onclick="showAdminTab('students')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-tab="students">
        <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg> จัดการผู้สอบ </button> <button onclick="showAdminTab('settings')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-tab="settings">
        <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> ตั้งค่าเวลา </button>
       <div class="border-t mt-4 pt-4"><button onclick="adminLogout()" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-red-600">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
         </svg> ออกจากระบบ </button>
       </div>
      </nav>
     </div><!-- Mobile Menu -->
     <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg z-50 border-t">
      <div class="flex justify-around py-2"><button onclick="showAdminTab('questions')" class="flex flex-col items-center p-2 text-sky-600" data-tab-mobile="questions">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg><span class="text-xs">ข้อสอบ</span> </button> <button onclick="showAdminTab('results')" class="flex flex-col items-center p-2 text-gray-500" data-tab-mobile="results">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg><span class="text-xs">ผลสอบ</span> </button> <button onclick="showAdminTab('students')" class="flex flex-col items-center p-2 text-gray-500" data-tab-mobile="students">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg><span class="text-xs">ผู้สอบ</span> </button> <button onclick="showAdminTab('settings')" class="flex flex-col items-center p-2 text-gray-500" data-tab-mobile="settings">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg><span class="text-xs">เวลา</span> </button> <button onclick="adminLogout()" class="flex flex-col items-center p-2 text-red-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg><span class="text-xs">ออก</span> </button>
      </div>
     </div><!-- Main Content -->
     <div class="flex-1 md:ml-64 p-4 md:p-6 pb-24 md:pb-6"><!-- Questions Management -->
      <div id="admin-questions" class="admin-content">
       <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold text-sky-800">จัดการข้อสอบ</h2>
        <div class="flex gap-2 flex-wrap"><button onclick="showAddQuestionModal()" class="btn-primary text-white px-6 py-2 rounded-xl flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg> เพิ่มข้อสอบ </button> <button onclick="showImportExcelModal()" class="bg-emerald-500 text-white px-6 py-2 rounded-xl flex items-center gap-2 hover:bg-emerald-600 transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg> นำเข้า Excel </button>
        </div>
       </div>
       <div id="questions-list" class="space-y-4"><!-- Questions will be rendered here -->
       </div>
      </div><!-- Results Management -->
      <div id="admin-results" class="admin-content hidden">
       <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold text-sky-800">ผลการสอบ</h2>
        <div class="flex gap-2"><button onclick="refreshResults()" class="bg-sky-100 text-sky-600 px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-sky-200 transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg> รีเฟรช </button> <button onclick="exportCSV()" class="bg-emerald-500 text-white px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-emerald-600 transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg> Export CSV </button>
        </div>
       </div>
       <div class="bg-white rounded-xl p-4 mb-4"><input type="text" id="search-results" oninput="searchResults()" placeholder="ค้นหาชื่อหรือเลขที่..." class="w-full px-4 py-2 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none">
       </div>
       <div id="results-list" class="bg-white rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-sky-50">
           <tr>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">ลำดับ</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">ชื่อ-สกุล</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">เลขที่</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">ห้อง</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">คะแนน</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">เวลา</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">สถานะ</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">จัดการ</th>
           </tr>
          </thead>
          <tbody id="results-tbody"><!-- Results will be rendered here -->
          </tbody>
         </table>
        </div>
       </div>
      </div><!-- Students Management -->
      <div id="admin-students" class="admin-content hidden">
       <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold text-sky-800">จัดการผู้สอบ</h2><button onclick="refreshStudents()" class="bg-sky-100 text-sky-600 px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-sky-200 transition-all">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
         </svg> รีเฟรช </button>
       </div>
       <div class="bg-white rounded-xl p-4 mb-4"><input type="text" id="search-students" oninput="searchStudents()" placeholder="ค้นหาชื่อหรือเลขที่..." class="w-full px-4 py-2 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none">
       </div>
       <div id="students-list" class="bg-white rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-sky-50">
           <tr>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">ลำดับ</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">ชื่อ-สกุล</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">เลขที่</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">ห้อง</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">สถานะ</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-sky-800">จัดการ</th>
           </tr>
          </thead>
          <tbody id="students-tbody"><!-- Students will be rendered here -->
          </tbody>
         </table>
        </div>
       </div>
      </div><!-- Timer Settings -->
      <div id="admin-settings" class="admin-content hidden">
       <h2 class="text-2xl font-bold text-sky-800 mb-6">ตั้งค่าเวลาสอบ</h2>
       <div class="bg-white rounded-xl p-6 max-w-md">
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">เวลาสอบ (นาที)</label> <input type="number" id="exam-time" value="60" min="1" class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 outline-none">
         </div>
         <div class="flex items-center gap-3"><input type="checkbox" id="enable-timer" class="w-5 h-5 text-sky-600 rounded"> <label for="enable-timer" class="text-gray-700">เปิดใช้งานจับเวลา</label>
         </div><button onclick="saveTimerSettings()" class="w-full btn-primary text-white py-3 rounded-xl"> บันทึกการตั้งค่า </button>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyABrzk3SHN0lVpBY97xDQZdUgOKREb89aQ",
      authDomain: "test-biology-47fcc.firebaseapp.com",
      projectId: "test-biology-47fcc",
      storageBucket: "test-biology-47fcc.firebasestorage.app",
      messagingSenderId: "758750642719",
      appId: "1:758750642719:web:d4d70897d1839886d9cb2a",
      measurementId: "G-VTGK8GY9DK"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Default Config
    const defaultConfig = {
      exam_title: 'ชีววิทยา 6',
      exam_topic: 'ระบบนิเวศและสิ่งแวดล้อม',
      primary_color: '#0ea5e9',
      background_color: '#e0f2fe',
      text_color: '#0c4a6e',
      surface_color: '#ffffff',
      accent_color: '#10b981'
    };

    let config = { ...defaultConfig };

    // App State
    let currentUser = null;
    let isAdmin = false;
    let questions = [];
    let currentQuestionIndex = 0;
    let studentAnswers = {};
    let studentInfo = { name: '', number: '', classroom: '' };
    let currentStudentDocId = null; // Store current student document ID for status updates
    let warningCount = 0;
    let examTimer = null;
    let examTimeLeft = 0;
    let examStartTime = null;
    let timerSettings = { enabled: false, minutes: 60 };
    let allResults = [];
    let allStudents = [];
    let isAway = false; // Flag to check if user is away

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          applyConfig();
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            },
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (v) => { config.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (v) => { config.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['exam_title', config.exam_title || defaultConfig.exam_title],
          ['exam_topic', config.exam_topic || defaultConfig.exam_topic]
        ])
      });
    }

    function applyConfig() {
      document.getElementById('header-title').textContent = `ระบบข้อสอบปลายภาค วิชา ${config.exam_title || defaultConfig.exam_title}`;
      document.getElementById('exam-topic-display').textContent = `หัวข้อ: ${config.exam_topic || defaultConfig.exam_topic}`;
    }

    // Load questions from Firebase
    async function loadQuestions() {
      try {
        const snapshot = await db.collection('questions').orderBy('order').get();
        questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (questions.length === 0) {
          await createDefaultQuestions();
        }
      } catch (error) {
        console.error('Error loading questions:', error);
        questions = generateDefaultQuestions();
      }
    }

    // Generate default questions
    function generateDefaultQuestions() {
      const topics = [
        { q: 'ระบบนิเวศคืออะไร', choices: ['ความสัมพันธ์ระหว่างสิ่งมีชีวิตกับสิ่งแวดล้อม', 'กลุ่มสิ่งมีชีวิต', 'สิ่งแวดล้อมทางกายภาพ', 'ห่วงโซ่อาหาร'], answer: 0 },
        { q: 'ผู้ผลิตในระบบนิเวศคือสิ่งมีชีวิตประเภทใด', choices: ['พืช', 'สัตว์กินพืช', 'สัตว์กินเนื้อ', 'แบคทีเรีย'], answer: 0 },
        { q: 'การสังเคราะห์ด้วยแสงต้องการสิ่งใดบ้าง', choices: ['น้ำ แสง และคาร์บอนไดออกไซด์', 'น้ำและออกซิเจน', 'แสงและไนโตรเจน', 'คาร์บอนไดออกไซด์และออกซิเจน'], answer: 0 },
        { q: 'ก๊าซที่เป็นผลผลิตจากการสังเคราะห์ด้วยแสง', choices: ['ออกซิเจน', 'คาร์บอนไดออกไซด์', 'ไนโตรเจน', 'มีเทน'], answer: 0 },
        { q: 'สิ่งมีชีวิตที่กินซากพืชซากสัตว์เรียกว่าอะไร', choices: ['ผู้ย่อยสลาย', 'ผู้ผลิต', 'ผู้บริโภค', 'ผู้ล่า'], answer: 0 },
        { q: 'ห่วงโซ่อาหารเริ่มต้นจากสิ่งใด', choices: ['ผู้ผลิต', 'ผู้บริโภคลำดับที่ 1', 'ผู้บริโภคลำดับที่ 2', 'ผู้ย่อยสลาย'], answer: 0 },
        { q: 'สายใยอาหารคืออะไร', choices: ['เครือข่ายของห่วงโซ่อาหารที่เชื่อมโยงกัน', 'ห่วงโซ่อาหารเดี่ยว', 'การถ่ายทอดพลังงาน', 'วัฏจักรของสาร'], answer: 0 },
        { q: 'พลังงานในระบบนิเวศถ่ายทอดอย่างไร', choices: ['จากผู้ผลิตไปผู้บริโภค', 'จากผู้บริโภคไปผู้ผลิต', 'แบบวงจร', 'แบบสุ่ม'], answer: 0 },
        { q: 'ปริมาณพลังงานที่ถ่ายทอดในแต่ละลำดับขั้นลดลงประมาณเท่าไร', choices: ['90%', '50%', '10%', '100%'], answer: 0 },
        { q: 'พีระมิดพลังงานแสดงถึงอะไร', choices: ['การถ่ายทอดพลังงานในระบบนิเวศ', 'จำนวนสิ่งมีชีวิต', 'ความหลากหลายทางชีวภาพ', 'การกระจายพันธุ์'], answer: 0 },
        { q: 'วัฏจักรน้ำเริ่มต้นจากกระบวนการใด', choices: ['การระเหย', 'การควบแน่น', 'การตกตะกอน', 'การไหลซึม'], answer: 0 },
        { q: 'การควบแน่นเกิดขึ้นเมื่อใด', choices: ['ไอน้ำเย็นตัวลง', 'น้ำร้อนขึ้น', 'น้ำแข็งละลาย', 'หิมะตก'], answer: 0 },
        { q: 'วัฏจักรคาร์บอนเกี่ยวข้องกับกระบวนการใด', choices: ['การสังเคราะห์ด้วยแสงและการหายใจ', 'การระเหยเท่านั้น', 'การย่อยสลายเท่านั้น', 'การตรึงไนโตรเจน'], answer: 0 },
        { q: 'ไนโตรเจนในอากาศถูกตรึงโดยสิ่งมีชีวิตใด', choices: ['แบคทีเรียในรากพืชตระกูลถั่ว', 'พืชทั่วไป', 'สัตว์กินพืช', 'เชื้อรา'], answer: 0 },
        { q: 'มลพิษทางอากาศที่สำคัญได้แก่อะไร', choices: ['ฝุ่น PM2.5', 'ออกซิเจน', 'ไนโตรเจน', 'ไอน้ำ'], answer: 0 },
        { q: 'ภาวะเรือนกระจกเกิดจากก๊าซใดเป็นหลัก', choices: ['คาร์บอนไดออกไซด์', 'ออกซิเจน', 'ไนโตรเจน', 'ฮีเลียม'], answer: 0 },
        { q: 'ผลกระทบของภาวะโลกร้อนคืออะไร', choices: ['น้ำแข็งขั้วโลกละลาย', 'อุณหภูมิลดลง', 'ปริมาณน้ำฝนลดลง', 'ป่าไม้เพิ่มขึ้น'], answer: 0 },
        { q: 'การอนุรักษ์ทรัพยากรธรรมชาติทำได้อย่างไร', choices: ['ลดการใช้ ใช้ซ้ำ และรีไซเคิล', 'ใช้ทรัพยากรให้มากที่สุด', 'ตัดไม้ทำลายป่า', 'เผาขยะ'], answer: 0 },
        { q: 'พลังงานหมุนเวียนได้แก่อะไร', choices: ['พลังงานแสงอาทิตย์', 'น้ำมัน', 'ถ่านหิน', 'ก๊าซธรรมชาติ'], answer: 0 },
        { q: 'ความหลากหลายทางชีวภาพหมายถึงอะไร', choices: ['ความแตกต่างของสิ่งมีชีวิตทุกระดับ', 'จำนวนสัตว์', 'จำนวนพืช', 'พื้นที่ป่า'], answer: 0 },
        { q: 'สาเหตุหลักของการสูญเสียความหลากหลายทางชีวภาพ', choices: ['การทำลายถิ่นที่อยู่', 'การอนุรักษ์', 'การปลูกป่า', 'การลดมลพิษ'], answer: 0 },
        { q: 'เขตรักษาพันธุ์สัตว์ป่ามีวัตถุประสงค์เพื่ออะไร', choices: ['คุ้มครองสัตว์ป่าและถิ่นที่อยู่', 'ล่าสัตว์', 'ตัดไม้', 'ทำการเกษตร'], answer: 0 },
        { q: 'การปลูกป่าทดแทนมีประโยชน์อย่างไร', choices: ['เพิ่มพื้นที่สีเขียวและดูดซับคาร์บอน', 'ลดปริมาณน้ำฝน', 'เพิ่มมลพิษ', 'ทำให้ดินเสื่อม'], answer: 0 },
        { q: 'แพลงก์ตอนพืชมีความสำคัญอย่างไร', choices: ['ผลิตออกซิเจนในทะเล', 'กินสัตว์น้ำ', 'ย่อยสลายซาก', 'ดูดซับไนโตรเจน'], answer: 0 },
        { q: 'ป่าชายเลนมีประโยชน์อย่างไร', choices: ['เป็นแหล่งอนุบาลสัตว์น้ำ', 'ผลิตน้ำมัน', 'สร้างมลพิษ', 'ทำให้น้ำเค็ม'], answer: 0 },
        { q: 'ปะการังฟอกขาวเกิดจากสาเหตุใด', choices: ['อุณหภูมิน้ำทะเลสูงขึ้น', 'น้ำทะเลเย็นลง', 'ปริมาณเกลือลดลง', 'ออกซิเจนเพิ่มขึ้น'], answer: 0 },
        { q: 'การตัดไม้ทำลายป่าส่งผลกระทบอย่างไร', choices: ['น้ำท่วมและดินถล่ม', 'อากาศดีขึ้น', 'ฝนตกมากขึ้น', 'สัตว์ป่าเพิ่มขึ้น'], answer: 0 },
        { q: 'ขยะพลาสติกส่งผลกระทบต่อสิ่งแวดล้อมอย่างไร', choices: ['ย่อยสลายยากและเป็นพิษต่อสัตว์', 'ย่อยสลายง่าย', 'เป็นอาหารสัตว์', 'ทำให้ดินอุดมสมบูรณ์'], answer: 0 },
        { q: 'การใช้สารเคมีในการเกษตรส่งผลอย่างไร', choices: ['ปนเปื้อนในดินและน้ำ', 'เพิ่มความอุดมสมบูรณ์ของดินตลอดกาล', 'ไม่มีผลกระทบ', 'ทำให้สัตว์เพิ่มขึ้น'], answer: 0 },
        { q: 'การเผาไหม้เชื้อเพลิงฟอสซิลปล่อยก๊าซใด', choices: ['คาร์บอนไดออกไซด์', 'ออกซิเจน', 'ไนโตรเจน', 'ฮีเลียม'], answer: 0 },
        { q: 'ฝนกรดเกิดจากสารใดในอากาศ', choices: ['ซัลเฟอร์ไดออกไซด์และไนโตรเจนออกไซด์', 'ออกซิเจน', 'คาร์บอนมอนอกไซด์', 'มีเทน'], answer: 0 },
        { q: 'ชั้นโอโซนมีหน้าที่อะไร', choices: ['กรองรังสี UV จากดวงอาทิตย์', 'ผลิตออกซิเจน', 'สร้างฝน', 'เพิ่มอุณหภูมิ'], answer: 0 },
        { q: 'สาร CFC ทำลายชั้นโอโซนอย่างไร', choices: ['ทำปฏิกิริยากับโอโซนทำให้สลายตัว', 'เพิ่มปริมาณโอโซน', 'ไม่มีผลกระทบ', 'ทำให้โอโซนเพิ่มขึ้น'], answer: 0 },
        { q: 'การจัดการขยะที่ดีควรทำอย่างไร', choices: ['แยกขยะตามประเภท', 'ทิ้งรวมกัน', 'เผาทั้งหมด', 'ฝังทั้งหมด'], answer: 0 },
        { q: 'พลังงานลมมีข้อดีอย่างไร', choices: ['ไม่ปล่อยก๊าซเรือนกระจก', 'ใช้ได้ตลอดเวลา', 'ราคาถูกมาก', 'ติดตั้งง่าย'], answer: 0 },
        { q: 'การเกษตรยั่งยืนคืออะไร', choices: ['การเกษตรที่ไม่ทำลายสิ่งแวดล้อม', 'การใช้สารเคมีมาก', 'การเผาป่าทำไร่', 'การปลูกพืชเชิงเดี่ยว'], answer: 0 },
        { q: 'ดัชนีคุณภาพอากาศ (AQI) ใช้วัดอะไร', choices: ['ระดับมลพิษในอากาศ', 'อุณหภูมิ', 'ความชื้น', 'ความเร็วลม'], answer: 0 },
        { q: 'น้ำเสียจากโรงงานควรบำบัดอย่างไร', choices: ['ผ่านระบบบำบัดก่อนปล่อย', 'ปล่อยลงแหล่งน้ำโดยตรง', 'ระเหยสู่อากาศ', 'ไม่ต้องบำบัด'], answer: 0 },
        { q: 'การอนุรักษ์พลังงานในชีวิตประจำวันทำได้อย่างไร', choices: ['ปิดไฟเมื่อไม่ใช้', 'เปิดแอร์ตลอดเวลา', 'ใช้น้ำมากๆ', 'เปิดน้ำทิ้งไว้'], answer: 0 }
      ];

      return topics.map((t, i) => ({
        id: `q${i + 1}`,
        order: i + 1,
        question: `${i + 1}. ${t.q}`,
        choices: t.choices,
        correctAnswer: t.answer
      }));
    }

    // Create default questions in Firebase
    async function createDefaultQuestions() {
      const defaultQuestions = generateDefaultQuestions();
      const batch = db.batch();
      
      for (const q of defaultQuestions) {
        const docRef = db.collection('questions').doc(q.id);
        batch.set(docRef, q);
      }
      
      try {
        await batch.commit();
        questions = defaultQuestions;
      } catch (error) {
        console.error('Error creating default questions:', error);
        questions = defaultQuestions;
      }
    }

    // Registration form submit
    document.getElementById('registration-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('student-name').value.trim();
      const number = document.getElementById('student-number').value.trim();
      const classroom = document.getElementById('student-classroom').value.trim();
      
      if (!name || !number || !classroom) {
        Swal.fire({
          icon: 'error',
          title: 'ข้อมูลไม่ครบ',
          text: 'กรุณากรอกชื่อ-สกุล เลขที่ และเลือกห้อง',
          confirmButtonColor: '#0ea5e9'
        });
        return;
      }
      
      studentInfo = { name, number, classroom };

      // เช็คว่าเคยสอบไปแล้วหรือยัง
      try {
        const checkQuery = await db.collection('students').where('number', '==', number).get();
        if (!checkQuery.empty) {
            // เจอข้อมูลเก่า
            const existingDoc = checkQuery.docs[0];
            const existingData = existingDoc.data();
            
            if (existingData.status === 'ส่งแล้ว' || existingData.status === 'ถูกยุติการสอบ') {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถเข้าสอบได้',
                    text: `สถานะของคุณคือ: ${existingData.status}`,
                    confirmButtonColor: '#0ea5e9'
                });
                return;
            } else {
                // ถ้าสถานะเป็น "กำลังสอบ" (เช่น เน็ตหลุด) ให้อัปเดตเวลาและเข้าสอบต่อได้
                currentStudentDocId = existingDoc.id;
                await db.collection('students').doc(currentStudentDocId).update({
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'กำลังสอบ' // ยืนยันสถานะ
                });
            }
        } else {
            // ไม่เจอข้อมูลเก่า สร้างใหม่
            const newDoc = await db.collection('students').add({
                name,
                number,
                classroom,
                startTime: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'กำลังสอบ'
            });
            currentStudentDocId = newDoc.id;
        }
      } catch (error) {
        console.error('Error checking/saving student:', error);
        // Fallback กรณีมีปัญหา (เพื่อไม่ให้เด็กติด)
         const newDoc = await db.collection('students').add({
            name,
            number,
            classroom,
            startTime: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'กำลังสอบ'
        });
        currentStudentDocId = newDoc.id;
      }
      
      await loadQuestions();
      startExam();
    });

    // Start exam
    function startExam() {
      document.getElementById('registration-page').classList.add('hidden');
      document.getElementById('exam-page').classList.remove('hidden');
      document.getElementById('timer-display').classList.remove('hidden');
      document.getElementById('student-info-display').textContent = `${studentInfo.name} (เลขที่ ${studentInfo.number} ห้อง ${studentInfo.classroom})`;
      
      examStartTime = Date.now();
      
      // Load timer settings
      loadTimerSettings();
      
      // Setup anti-cheat
      setupAntiCheat();
      
      // Render first question
      renderQuestionNav();
      renderQuestion();
    }

    // Load timer settings
    async function loadTimerSettings() {
      try {
        const doc = await db.collection('settings').doc('timer').get();
        if (doc.exists) {
          timerSettings = doc.data();
        }
      } catch (error) {
        console.error('Error loading timer settings:', error);
      }
      
      if (timerSettings.enabled) {
        examTimeLeft = timerSettings.minutes * 60;
        startTimer();
      } else {
        // Count up timer
        startCountUpTimer();
      }
    }

    // Start countdown timer
    function startTimer() {
      updateTimerDisplay();
      examTimer = setInterval(() => {
        examTimeLeft--;
        updateTimerDisplay();
        
        if (examTimeLeft <= 0) {
          clearInterval(examTimer);
          autoSubmitExam();
        }
      }, 1000);
    }

    // Start count up timer
    function startCountUpTimer() {
      examTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        document.getElementById('timer-text').textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // Update timer display
    function updateTimerDisplay() {
      const hours = Math.floor(examTimeLeft / 3600);
      const minutes = Math.floor((examTimeLeft % 3600) / 60);
      const seconds = examTimeLeft % 60;
      document.getElementById('timer-text').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      if (examTimeLeft <= 300) {
        document.getElementById('timer-display').classList.add('bg-red-100');
        document.getElementById('timer-text').classList.add('text-red-600');
      }
    }

    // Auto submit exam when time is up
    function autoSubmitExam() {
      Swal.fire({
        icon: 'warning',
        title: 'หมดเวลาสอบ',
        text: 'ระบบจะส่งข้อสอบให้อัตโนมัติ',
        confirmButtonColor: '#0ea5e9',
        allowOutsideClick: false
      }).then(() => {
        submitExamData();
      });
    }

    // Setup anti-cheat measures
    function setupAntiCheat() {
      // Visibility change detection
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            onUserLeft();
        } else {
            onUserReturned();
        }
      });
      
      // Window blur detection
      window.addEventListener('blur', onUserLeft);
      window.addEventListener('focus', onUserReturned);
      
      // Prevent context menu
      document.addEventListener('contextmenu', (e) => e.preventDefault());
    }

    function onUserLeft() {
      // ถ้าไม่ได้อยู่ในหน้าสอบจริง ไม่ต้องนับ
      if (document.getElementById('exam-page').classList.contains('hidden')) return;
      if (isAdmin) return;
      
      // ถ้าสถานะเป็น "ไม่อยู่" แล้ว ไม่ต้องนับเพิ่ม (ล็อคไว้)
      if (isAway) return;

      isAway = true; // ล็อคสถานะว่าไม่อยู่
      warningCount++;
      
      document.getElementById('warning-display').classList.remove('hidden');
      document.getElementById('warning-count').textContent = warningCount;
      
      if (warningCount >= 3) {
        terminateExam();
      } else {
        Swal.fire({
          icon: 'warning',
          title: `คำเตือนครั้งที่ ${warningCount}`,
          html: `ตรวจพบการออกนอกหน้าจอ<br>ห้ามพับหน้าจอ หรือเปิดแท็บอื่น`,
          confirmButtonColor: '#f59e0b',
          timer: 3000,
          timerProgressBar: true
        });
      }
    }

    function onUserReturned() {
        // เมื่อกลับเข้ามา ปลดล็อคให้นับครั้งต่อไปได้
        isAway = false;
    }

    function terminateExam() {
         clearInterval(examTimer);
         window.removeEventListener('blur', onUserLeft);
         window.removeEventListener('focus', onUserReturned);
         
         Swal.fire({
          icon: 'error',
          title: 'ยุติการสอบ',
          text: 'ตรวจพบการทุจริต 3 ครั้ง ระบบยุติการสอบทันที',
          confirmButtonColor: '#ef4444',
          allowOutsideClick: false
        }).then(() => {
          submitExamData(true);
        });
    }

    // Render question navigation
    function renderQuestionNav() {
      const nav = document.getElementById('question-nav');
      nav.innerHTML = questions.map((q, i) => `
        <button onclick="goToQuestion(${i})" 
          class="w-8 h-8 rounded-lg text-sm font-medium transition-all
          ${i === currentQuestionIndex ? 'bg-sky-500 text-white' : 
            studentAnswers[q.id] !== undefined ? 'bg-emerald-500 text-white' : 'bg-white border border-sky-200 text-sky-600 hover:bg-sky-50'}">
          ${i + 1}
        </button>
      `).join('');
    }

    // Render current question
    function renderQuestion() {
      const q = questions[currentQuestionIndex];
      if (!q) return;
      
      const container = document.getElementById('question-container');
      // แก้ไขการแสดงผลจาก A, B, C, D เป็น 1, 2, 3, 4
      container.innerHTML = `
        <div class="question-card">
          <h3 class="text-lg font-semibold text-gray-800 mb-6">${q.question}</h3>
          <div class="space-y-3">
            ${q.choices.map((choice, i) => `
              <label class="flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all
                ${studentAnswers[q.id] === i ? 'border-sky-500 bg-sky-50' : 'border-gray-200 hover:border-sky-300'}">
                <input type="radio" name="answer" value="${i}" 
                  ${studentAnswers[q.id] === i ? 'checked' : ''}
                  onchange="selectAnswer(${i})"
                  class="w-5 h-5 text-sky-600">
                <span class="ml-3 text-gray-700">${i + 1}. ${choice}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `;
      
      document.getElementById('current-question-num').textContent = currentQuestionIndex + 1;
      renderQuestionNav();
    }

    // Select answer
    function selectAnswer(answerIndex) {
      const q = questions[currentQuestionIndex];
      studentAnswers[q.id] = answerIndex;
      renderQuestionNav();
    }

    // Navigation
    function goToQuestion(index) {
      currentQuestionIndex = index;
      renderQuestion();
    }

    function prevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
      }
    }

    // Submit exam
    async function submitExam() {
      const answeredCount = Object.keys(studentAnswers).length;
      const unansweredCount = questions.length - answeredCount;
      
      const result = await Swal.fire({
        icon: 'question',
        title: 'ยืนยันส่งข้อสอบ?',
        html: `ตอบแล้ว: ${answeredCount} ข้อ<br>ยังไม่ตอบ: ${unansweredCount} ข้อ`,
        showCancelButton: true,
        confirmButtonText: 'ส่งข้อสอบ',
        cancelButtonText: 'กลับไปทำต่อ',
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280'
      });
      
      if (result.isConfirmed) {
        await submitExamData();
      }
    }

    // Submit exam data
    async function submitExamData(cheated = false) {
      clearInterval(examTimer);
      window.removeEventListener('blur', onUserLeft);
      window.removeEventListener('focus', onUserReturned);
      
      // Calculate score
      let score = 0;
      questions.forEach(q => {
        if (studentAnswers[q.id] === q.correctAnswer) {
          score++;
        }
      });
      
      const endTime = Date.now();
      const duration = Math.floor((endTime - examStartTime) / 1000);
      const durationStr = `${Math.floor(duration / 60)} นาที ${duration % 60} วินาที`;
      
      const status = cheated ? 'ถูกยุติการสอบ' : 'ส่งแล้ว';

      // Update Student Status in 'students' collection (Real-time status for Admin)
      if (currentStudentDocId) {
          try {
              await db.collection('students').doc(currentStudentDocId).update({
                  status: status
              });
          } catch (e) {
              console.error('Error updating student status:', e);
          }
      }

      // Save result to 'results' collection
      try {
        await db.collection('results').add({
          name: studentInfo.name,
          number: studentInfo.number,
          classroom: studentInfo.classroom,
          score,
          totalQuestions: questions.length,
          answers: studentAnswers,
          duration: durationStr,
          durationSeconds: duration,
          warnings: warningCount,
          cheated,
          status: status,
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error saving result:', error);
      }
      
      // Show result
      showResult(score, durationStr, cheated);
    }

    // Show result
    function showResult(score, duration, cheated) {
      document.getElementById('exam-page').classList.add('hidden');
      document.getElementById('timer-display').classList.add('hidden');
      document.getElementById('result-page').classList.remove('hidden');
      
      if (cheated) {
        document.getElementById('result-icon').className = 'w-24 h-24 bg-gradient-to-br from-red-400 to-red-600 rounded-full flex items-center justify-center mx-auto mb-4';
        document.getElementById('result-icon').innerHTML = `
          <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        `;
      }
      
      document.getElementById('result-name').textContent = `${studentInfo.name} (เลขที่ ${studentInfo.number} ห้อง ${studentInfo.classroom})`;
      document.getElementById('result-score').textContent = `${score}/${questions.length}`;
      document.getElementById('result-time').textContent = `เวลาที่ใช้: ${duration}`;
    }

    // Admin functions
    function showAdminLogin() {
      if (isAdmin) {
        showAdminPage();
        return;
      }
      
      Swal.fire({
        title: 'เข้าสู่ระบบแอดมิน',
        html: `
          <input type="email" id="admin-email" class="swal2-input" placeholder="Email">
          <input type="password" id="admin-password" class="swal2-input" placeholder="Password">
        `,
        showCancelButton: true,
        confirmButtonText: 'เข้าสู่ระบบ',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#0ea5e9',
        preConfirm: () => {
          const email = document.getElementById('admin-email').value;
          const password = document.getElementById('admin-password').value;
          return { email, password };
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const userCredential = await auth.signInWithEmailAndPassword(result.value.email, result.value.password);
            currentUser = userCredential.user;
            isAdmin = true;
            showAdminPage();
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'เข้าสู่ระบบไม่สำเร็จ',
              text: error.message,
              confirmButtonColor: '#0ea5e9'
            });
          }
        }
      });
    }

    function showAdminPage() {
      document.getElementById('registration-page').classList.add('hidden');
      document.getElementById('exam-page').classList.add('hidden');
      document.getElementById('result-page').classList.add('hidden');
      document.getElementById('admin-page').classList.remove('hidden');
      document.getElementById('admin-email-display').textContent = currentUser?.email || '';
      
      loadAdminData();
    }

    async function loadAdminData() {
      await loadQuestions();
      await loadResults();
      await loadStudents();
      await loadTimerSettingsAdmin();
      renderQuestionsAdmin();
    }

    function showAdminTab(tab) {
      // Hide all content
      document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(`admin-${tab}`).classList.remove('hidden');
      
      // Update sidebar
      document.querySelectorAll('.sidebar-item').forEach(el => {
        el.classList.remove('active');
        if (el.dataset.tab === tab) el.classList.add('active');
      });
      
      // Update mobile nav
      document.querySelectorAll('[data-tab-mobile]').forEach(el => {
        el.classList.remove('text-sky-600');
        el.classList.add('text-gray-500');
        if (el.dataset.tabMobile === tab) {
          el.classList.add('text-sky-600');
          el.classList.remove('text-gray-500');
        }
      });
    }

    // Render questions for admin
    function renderQuestionsAdmin() {
      const container = document.getElementById('questions-list');
      // แก้ไขการแสดงผลจาก A, B, C, D เป็น 1, 2, 3, 4
      container.innerHTML = questions.map((q, i) => `
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800">${q.question}</h4>
              <div class="mt-2 text-sm text-gray-600">
                ${q.choices.map((c, j) => `
                  <p class="${j === q.correctAnswer ? 'text-emerald-600 font-medium' : ''}">${j + 1}. ${c}</p>
                `).join('')}
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="editQuestion('${q.id}')" class="p-2 bg-sky-100 text-sky-600 rounded-lg hover:bg-sky-200 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="deleteQuestion('${q.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Add question modal
    function showAddQuestionModal() {
      // แก้ไข Label จาก ก, ข, ค, ง เป็น 1, 2, 3, 4 และแก้ไข Value ใน Select
      Swal.fire({
        title: 'เพิ่มข้อสอบใหม่',
        html: `
          <div class="text-left space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">คำถาม</label>
              <textarea id="new-question" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 1</label>
              <input type="text" id="choice-a" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 2</label>
              <input type="text" id="choice-b" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 3</label>
              <input type="text" id="choice-c" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 4</label>
              <input type="text" id="choice-d" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เฉลย</label>
              <select id="correct-answer" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="0">1</option>
                <option value="1">2</option>
                <option value="2">3</option>
                <option value="3">4</option>
              </select>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'เพิ่ม',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#0ea5e9',
        preConfirm: () => {
          return {
            question: document.getElementById('new-question').value,
            choices: [
              document.getElementById('choice-a').value,
              document.getElementById('choice-b').value,
              document.getElementById('choice-c').value,
              document.getElementById('choice-d').value
            ],
            correctAnswer: parseInt(document.getElementById('correct-answer').value)
          };
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          const newQuestion = {
            order: questions.length + 1,
            question: `${questions.length + 1}. ${result.value.question}`,
            choices: result.value.choices,
            correctAnswer: result.value.correctAnswer
          };
          
          try {
            await db.collection('questions').add(newQuestion);
            await loadQuestions();
            renderQuestionsAdmin();
            Swal.fire({
              icon: 'success',
              title: 'เพิ่มข้อสอบสำเร็จ',
              confirmButtonColor: '#0ea5e9'
            });
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด',
              text: error.message,
              confirmButtonColor: '#0ea5e9'
            });
          }
        }
      });
    }

    // Show import Excel modal
    function showImportExcelModal() {
      // แก้ไขคำแนะนำการนำเข้า Excel
      Swal.fire({
        title: 'นำเข้าข้อสอบจาก Excel',
        html: `
          <div class="text-left space-y-4">
            <div>
              <p class="text-sm text-gray-600 mb-3">รูปแบบ Excel: คอลัมน์ A=คำถาม, B=ตัวเลือก 1, C=ตัวเลือก 2, D=ตัวเลือก 3, E=ตัวเลือก 4, F=เฉลย (0-3)</p>
              <input type="file" id="excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'นำเข้า',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#0ea5e9',
        preConfirm: () => {
          const file = document.getElementById('excel-file').files[0];
          if (!file) {
            Swal.showValidationMessage('กรุณาเลือกไฟล์ Excel');
            return false;
          }
          return file;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          await importExcelQuestions(result.value);
        }
      });
    }

    // Import Excel questions
    async function importExcelQuestions(file) {
      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 'A' });
            
            if (jsonData.length === 0) {
              Swal.fire({
                icon: 'error',
                title: 'ไฟล์ว่างเปล่า',
                text: 'กรุณาตรวจสอบไฟล์ Excel',
                confirmButtonColor: '#0ea5e9'
              });
              return;
            }
            
            // Process Excel data
            const importedQuestions = [];
            jsonData.forEach((row, index) => {
              if (row.A && row.B && row.C && row.D && row.E && row.F !== undefined) {
                importedQuestions.push({
                  order: index + 1,
                  question: `${index + 1}. ${row.A}`,
                  choices: [row.B, row.C, row.D, row.E],
                  correctAnswer: parseInt(row.F)
                });
              }
            });
            
            if (importedQuestions.length === 0) {
              Swal.fire({
                icon: 'error',
                title: 'ข้อมูลไม่ถูกต้อง',
                text: 'ตรวจสอบรูปแบบของไฟล์ Excel',
                confirmButtonColor: '#0ea5e9'
              });
              return;
            }
            
            // Confirm import
            const confirmResult = await Swal.fire({
              icon: 'question',
              title: 'ยืนยันการนำเข้า',
              html: `พบข้อสอบ ${importedQuestions.length} ข้อ<br><br>ระบบจะลบข้อสอบเดิมทั้งหมด ยืนยัน?`,
              showCancelButton: true,
              confirmButtonText: 'นำเข้า',
              cancelButtonText: 'ยกเลิก',
              confirmButtonColor: '#0ea5e9'
            });
            
            if (confirmResult.isConfirmed) {
              // Delete existing questions
              const batch = db.batch();
              questions.forEach(q => {
                batch.delete(db.collection('questions').doc(q.id));
              });
              await batch.commit();
              
              // Add new questions
              const addBatch = db.batch();
              importedQuestions.forEach((q, idx) => {
                const docRef = db.collection('questions').doc(`q${idx + 1}`);
                addBatch.set(docRef, q);
              });
              await addBatch.commit();
              
              await loadQuestions();
              renderQuestionsAdmin();
              
              Swal.fire({
                icon: 'success',
                title: 'นำเข้าสำเร็จ',
                text: `นำเข้าข้อสอบ ${importedQuestions.length} ข้อ`,
                confirmButtonColor: '#0ea5e9'
              });
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด',
              text: error.message,
              confirmButtonColor: '#0ea5e9'
            });
          }
        };
        reader.readAsBinaryString(file);
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: error.message,
          confirmButtonColor: '#0ea5e9'
        });
      }
    }

    // Edit question
    async function editQuestion(id) {
      const q = questions.find(q => q.id === id);
      if (!q) return;
      
      const questionText = q.question.replace(/^\d+\.\s*/, '');
      
      // แก้ไข Label จาก ก, ข, ค, ง เป็น 1, 2, 3, 4 และแก้ไข Value ใน Select
      Swal.fire({
        title: 'แก้ไขข้อสอบ',
        html: `
          <div class="text-left space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">คำถาม</label>
              <textarea id="edit-question" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2">${questionText}</textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 1</label>
              <input type="text" id="edit-choice-a" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${q.choices[0]}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 2</label>
              <input type="text" id="edit-choice-b" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${q.choices[1]}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 3</label>
              <input type="text" id="edit-choice-c" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${q.choices[2]}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตัวเลือก 4</label>
              <input type="text" id="edit-choice-d" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${q.choices[3]}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เฉลย</label>
              <select id="edit-correct-answer" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="0" ${q.correctAnswer === 0 ? 'selected' : ''}>1</option>
                <option value="1" ${q.correctAnswer === 1 ? 'selected' : ''}>2</option>
                <option value="2" ${q.correctAnswer === 2 ? 'selected' : ''}>3</option>
                <option value="3" ${q.correctAnswer === 3 ? 'selected' : ''}>4</option>
              </select>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'บันทึก',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#0ea5e9',
        preConfirm: () => {
          return {
            question: document.getElementById('edit-question').value,
            choices: [
              document.getElementById('edit-choice-a').value,
              document.getElementById('edit-choice-b').value,
              document.getElementById('edit-choice-c').value,
              document.getElementById('edit-choice-d').value
            ],
            correctAnswer: parseInt(document.getElementById('edit-correct-answer').value)
          };
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await db.collection('questions').doc(id).update({
              question: `${q.order}. ${result.value.question}`,
              choices: result.value.choices,
              correctAnswer: result.value.correctAnswer
            });
            await loadQuestions();
            renderQuestionsAdmin();
            Swal.fire({
              icon: 'success',
              title: 'แก้ไขสำเร็จ',
              confirmButtonColor: '#0ea5e9'
            });
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด',
              text: error.message,
              confirmButtonColor: '#0ea5e9'
            });
          }
        }
      });
    }

    // Delete question
    async function deleteQuestion(id) {
      const result = await Swal.fire({
        icon: 'warning',
        title: 'ยืนยันการลบ?',
        text: 'ข้อสอบนี้จะถูกลบออกจากระบบ',
        showCancelButton: true,
        confirmButtonText: 'ลบ',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280'
      });
      
      if (result.isConfirmed) {
        try {
          await db.collection('questions').doc(id).delete();
          await loadQuestions();
          renderQuestionsAdmin();
          Swal.fire({
            icon: 'success',
            title: 'ลบสำเร็จ',
            confirmButtonColor: '#0ea5e9'
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด',
            text: error.message,
            confirmButtonColor: '#0ea5e9'
          });
        }
      }
    }

    // Load results
    async function loadResults() {
      try {
        const snapshot = await db.collection('results').orderBy('submittedAt', 'desc').get();
        allResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderResults();
      } catch (error) {
        console.error('Error loading results:', error);
      }
    }

    // Render results
    function renderResults(filteredResults = null) {
      const results = filteredResults || allResults;
      const tbody = document.getElementById('results-tbody');
      tbody.innerHTML = results.map((r, i) => `
        <tr class="border-b border-gray-100 hover:bg-sky-50">
          <td class="px-4 py-3">${i + 1}</td>
          <td class="px-4 py-3 font-medium">${r.name}</td>
          <td class="px-4 py-3">${r.number}</td>
          <td class="px-4 py-3">${r.classroom || '-'}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded-full text-sm ${r.score >= r.totalQuestions * 0.5 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
              ${r.score}/${r.totalQuestions}
            </span>
          </td>
          <td class="px-4 py-3 text-sm">${r.duration}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded-full text-xs ${r.cheated ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">
              ${r.status}
            </span>
          </td>
          <td class="px-4 py-3">
            <button onclick="deleteResult('${r.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Search results
    function searchResults() {
      const query = document.getElementById('search-results').value.toLowerCase();
      const filtered = allResults.filter(r => 
        r.name.toLowerCase().includes(query) || 
        r.number.toString().includes(query)
      );
      renderResults(filtered);
    }

    // Refresh results
    async function refreshResults() {
      await loadResults();
      Swal.fire({
        icon: 'success',
        title: 'รีเฟรชสำเร็จ',
        timer: 1500,
        showConfirmButton: false
      });
    }

    // Delete result
    async function deleteResult(id) {
      const result = await Swal.fire({
        icon: 'warning',
        title: 'ยืนยันการลบ?',
        text: 'ผลสอบนี้จะถูกลบออกจากระบบ',
        showCancelButton: true,
        confirmButtonText: 'ลบ',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280'
      });
      
      if (result.isConfirmed) {
        try {
          await db.collection('results').doc(id).delete();
          await loadResults();
          Swal.fire({
            icon: 'success',
            title: 'ลบสำเร็จ',
            confirmButtonColor: '#0ea5e9'
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด',
            text: error.message,
            confirmButtonColor: '#0ea5e9'
          });
        }
      }
    }

    // Export CSV
    function exportCSV() {
      if (allResults.length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'ไม่มีข้อมูล',
          text: 'ยังไม่มีผลสอบให้ส่งออก',
          confirmButtonColor: '#0ea5e9'
        });
        return;
      }
      
      const headers = ['ลำดับ', 'ชื่อ-สกุล', 'เลขที่', 'ห้อง', 'คะแนน', 'คะแนนเต็ม', 'เวลาที่ใช้', 'สถานะ', 'คำเตือน'];
      const rows = allResults.map((r, i) => [
        i + 1,
        r.name,
        r.number,
        r.classroom || '-',
        r.score,
        r.totalQuestions,
        r.duration,
        r.status,
        r.warnings || 0
      ]);
      
      const csvContent = '\uFEFF' + [headers, ...rows].map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ผลสอบชีววิทยา6_${new Date().toLocaleDateString('th-TH')}.csv`;
      link.click();
      
      Swal.fire({
        icon: 'success',
        title: 'ส่งออกสำเร็จ',
        text: 'ไฟล์ CSV ถูกดาวน์โหลดแล้ว',
        confirmButtonColor: '#0ea5e9'
      });
    }

    // Load students
    async function loadStudents() {
      try {
        const snapshot = await db.collection('students').orderBy('startTime', 'desc').get();
        allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderStudents();
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    // Render students (Updated logic for status colors)
    function renderStudents(filteredStudents = null) {
      const students = filteredStudents || allStudents;
      const tbody = document.getElementById('students-tbody');
      tbody.innerHTML = students.map((s, i) => {
        let statusClass = 'bg-amber-100 text-amber-700'; // Default: กำลังสอบ
        let statusText = s.status || 'กำลังสอบ';

        if (statusText === 'ส่งแล้ว') {
            statusClass = 'bg-emerald-100 text-emerald-700';
        } else if (statusText === 'ถูกยุติการสอบ') {
            statusClass = 'bg-red-100 text-red-700';
        }

        return `
        <tr class="border-b border-gray-100 hover:bg-sky-50">
          <td class="px-4 py-3">${i + 1}</td>
          <td class="px-4 py-3 font-medium">${s.name}</td>
          <td class="px-4 py-3">${s.number}</td>
          <td class="px-4 py-3">${s.classroom || '-'}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded-full text-xs ${statusClass}">
              ${statusText}
            </span>
          </td>
          <td class="px-4 py-3 flex gap-2">
            <button onclick="editStudent('${s.id}')" class="p-2 bg-sky-100 text-sky-600 rounded-lg hover:bg-sky-200 transition-all">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
            <button onclick="deleteStudent('${s.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </td>
        </tr>
      `}).join('');
    }

    // Search students
    function searchStudents() {
      const query = document.getElementById('search-students').value.toLowerCase();
      const filtered = allStudents.filter(s => 
        s.name.toLowerCase().includes(query) || 
        s.number.toString().includes(query)
      );
      renderStudents(filtered);
    }

    // Refresh students
    async function refreshStudents() {
      await loadStudents();
      Swal.fire({
        icon: 'success',
        title: 'รีเฟรชสำเร็จ',
        timer: 1500,
        showConfirmButton: false
      });
    }

    // Edit student
    async function editStudent(id) {
      const s = allStudents.find(s => s.id === id);
      if (!s) return;
      
      Swal.fire({
        title: 'แก้ไขข้อมูลผู้สอบ',
        html: `
          <div class="text-left space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-สกุล</label>
              <input type="text" id="edit-student-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${s.name}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เลขที่</label>
              <input type="number" id="edit-student-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${s.number}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ห้อง</label>
              <select id="edit-student-classroom" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="ม.6/6" ${s.classroom === 'ม.6/6' ? 'selected' : ''}>ม.6/6</option>
                <option value="ม.6/7" ${s.classroom === 'ม.6/7' ? 'selected' : ''}>ม.6/7</option>
                <option value="ม.6/8" ${s.classroom === 'ม.6/8' ? 'selected' : ''}>ม.6/8</option>
                <option value="ม.6/9" ${s.classroom === 'ม.6/9' ? 'selected' : ''}>ม.6/9</option>
                <option value="ม.6/10" ${s.classroom === 'ม.6/10' ? 'selected' : ''}>ม.6/10</option>
                <option value="ม.6/11" ${s.classroom === 'ม.6/11' ? 'selected' : ''}>ม.6/11</option>
              </select>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'บันทึก',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#0ea5e9',
        preConfirm: () => {
          return {
            name: document.getElementById('edit-student-name').value,
            number: document.getElementById('edit-student-number').value,
            classroom: document.getElementById('edit-student-classroom').value
          };
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await db.collection('students').doc(id).update(result.value);
            await loadStudents();
            Swal.fire({
              icon: 'success',
              title: 'แก้ไขสำเร็จ',
              confirmButtonColor: '#0ea5e9'
            });
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด',
              text: error.message,
              confirmButtonColor: '#0ea5e9'
            });
          }
        }
      });
    }

    // Delete student
    async function deleteStudent(id) {
      const result = await Swal.fire({
        icon: 'warning',
        title: 'ยืนยันการลบ?',
        text: 'ข้อมูลผู้สอบจะถูกลบออกจากระบบ',
        showCancelButton: true,
        confirmButtonText: 'ลบ',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280'
      });
      
      if (result.isConfirmed) {
        try {
          await db.collection('students').doc(id).delete();
          await loadStudents();
          Swal.fire({
            icon: 'success',
            title: 'ลบสำเร็จ',
            confirmButtonColor: '#0ea5e9'
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด',
            text: error.message,
            confirmButtonColor: '#0ea5e9'
          });
        }
      }
    }

    // Save timer settings
    async function saveTimerSettings() {
      const minutes = parseInt(document.getElementById('exam-time').value);
      const enabled = document.getElementById('enable-timer').checked;
      
      try {
        await db.collection('settings').doc('timer').set({
          minutes,
          enabled
        });
        
        timerSettings = { minutes, enabled };
        
        Swal.fire({
          icon: 'success',
          title: 'บันทึกสำเร็จ',
          text: `ตั้งค่าเวลาสอบ ${minutes} นาที ${enabled ? '(เปิดใช้งาน)' : '(ปิดใช้งาน)'}`,
          confirmButtonColor: '#0ea5e9'
        });
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: error.message,
          confirmButtonColor: '#0ea5e9'
        });
      }
    }

    // Load timer settings for admin
    async function loadTimerSettingsAdmin() {
      try {
        const doc = await db.collection('settings').doc('timer').get();
        if (doc.exists) {
          const settings = doc.data();
          document.getElementById('exam-time').value = settings.minutes || 60;
          document.getElementById('enable-timer').checked = settings.enabled || false;
        }
      } catch (error) {
        console.error('Error loading timer settings:', error);
      }
    }

    // Admin logout
    function adminLogout() {
      Swal.fire({
        icon: 'question',
        title: 'ออกจากระบบ?',
        showCancelButton: true,
        confirmButtonText: 'ออกจากระบบ',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280'
      }).then(async (result) => {
        if (result.isConfirmed) {
          await auth.signOut();
          isAdmin = false;
          currentUser = null;
          document.getElementById('admin-page').classList.add('hidden');
          document.getElementById('registration-page').classList.remove('hidden');
        }
      });
    }

    // Initialize
    applyConfig();
  </script>
 </body>
</html>

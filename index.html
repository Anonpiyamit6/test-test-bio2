<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบข้อสอบปลายภาค ชีววิทยา 6</title>
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #7dd3fc 100%); }
    .card-shadow { box-shadow: 0 10px 40px rgba(14, 165, 233, 0.15); }
    .btn-primary { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); transition: all 0.3s ease; }
    .btn-primary:hover { background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3); }
    .btn-disabled { background: #cbd5e1; color: #64748b; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
    .question-card { transition: all 0.3s ease; }
    .question-card:hover { transform: translateY(-2px); }
    .sidebar-item { transition: all 0.2s ease; cursor: pointer; }
    .sidebar-item:hover { background: rgba(14, 165, 233, 0.1); }
    .sidebar-item.active { background: rgba(14, 165, 233, 0.2); border-left: 4px solid #0ea5e9; }
    .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
    @keyframes pulse-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .warning-pulse { animation: pulse-warning 1s infinite; }

    /* --- PRINT STYLES (PDF REPORT) --- */
    @media print {
        @page {
            size: A4;
            margin: 1.5cm;
        }
        body { 
            background: white !important; 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important;
        }
        
        /* Hide UI Elements */
        #app > header, 
        .sidebar-item, 
        .btn-primary,
        button,
        input,
        select,
        .no-print,
        #timer-display,
        .fixed, /* Hide mobile menu */
        #admin-page .w-64 /* Hide Sidebar */
        { display: none !important; }

        /* Reset Layout for Print */
        #app { overflow: visible !important; height: auto !important; }
        #admin-page { display: block !important; }
        .flex-1.md\:ml-64 { margin-left: 0 !important; padding: 0 !important; }
        
        /* Specific Print Areas */
        #print-header { display: block !important; margin-bottom: 20px; border-bottom: 2px solid #0ea5e9; padding-bottom: 15px; }
        #print-footer { display: flex !important; margin-top: 40px; page-break-inside: avoid; }
        
        /* Table Styling */
        #results-list { box-shadow: none !important; border: none !important; }
        table { width: 100%; border-collapse: collapse; font-size: 12pt; }
        thead { background-color: #0ea5e9 !important; color: white !important; }
        th { padding: 10px 8px !important; border: 1px solid #0c4a6e; text-align: center; font-weight: bold; }
        td { padding: 8px !important; border: 1px solid #cbd5e1; color: black !important; vertical-align: middle; }
        
        /* Zebra Striping for readability */
        tr:nth-child(even) { background-color: #f0f9ff !important; }
        
        /* Specific Column Alignments */
        td:nth-child(1), td:nth-child(3), td:nth-child(5), td:nth-child(6), td:nth-child(7) { text-align: center; }
        
        /* Status Badges in Print */
        .rounded-full { 
            border: 1px solid #ccc; 
            padding: 2px 8px; 
            background: white !important; 
            color: black !important;
            font-weight: normal;
            white-space: nowrap; /* Prevent text wrapping in print */
        }
    }
  </style>
 </head>
 <body class="h-full gradient-bg no-select">
  <div id="app" class="h-full overflow-auto">
   
   <!-- Header -->
   <header class="bg-white/90 backdrop-blur-sm shadow-md sticky top-0 z-50 no-print">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
     <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-sky-400 to-sky-600 rounded-xl flex items-center justify-center shadow-sm">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
      </div>
      <div>
       <h1 class="text-lg md:text-xl font-bold text-sky-800">ระบบข้อสอบปลายภาค ชีววิทยา 6</h1>
       <p class="text-xs text-sky-600">พัฒนาโดย ว่าที่ร้อยตรีอานนท์ เมืองแก้ว @2025</p>
      </div>
     </div>
     <div class="flex items-center gap-3">
      <div id="timer-display" class="hidden bg-sky-100 px-4 py-2 rounded-lg shadow-inner"><span class="text-sky-800 font-semibold" id="timer-text">00:00:00</span></div>
      <button onclick="showAdminLogin()" class="p-2 hover:bg-sky-100 rounded-full transition-colors duration-200">
       <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
      </button>
     </div>
    </div>
   </header>

   <!-- Student Registration Page -->
   <div id="registration-page" class="max-w-lg mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl card-shadow p-6 md:p-8 transform transition-all">
     <div class="text-center mb-6">
      <div class="w-20 h-20 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
      </div>
      <h2 class="text-2xl font-bold text-sky-800">ลงทะเบียนสอบ</h2>
      <p class="text-sky-600 mt-1">หัวข้อ: อนุกรมวิธาน ไบโอม และประชากร</p>
     </div>
     <form id="registration-form" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-สกุล</label> <input type="text" id="student-name" required class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition-all shadow-sm" placeholder="กรอกชื่อ-สกุล"></div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">เลขที่</label> <input type="number" id="student-number" required min="1" class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition-all shadow-sm" placeholder="กรอกเลขที่"></div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">ห้อง</label> 
        <select id="student-classroom" required class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition-all shadow-sm"> 
            <option value="">เลือกห้อง</option> <option value="ม.6/6">ม.6/6</option> <option value="ม.6/7">ม.6/7</option> <option value="ม.6/8">ม.6/8</option> <option value="ม.6/9">ม.6/9</option> <option value="ม.6/10">ม.6/10</option> <option value="ม.6/11">ม.6/11</option> 
        </select>
      </div>
      <button type="submit" class="w-full btn-primary text-white font-semibold py-3 rounded-xl transition-all shadow-lg hover:shadow-xl mt-4"> เริ่มทำข้อสอบ </button>
     </form>
     <div class="mt-6 p-4 bg-amber-50 rounded-xl border border-amber-200 shadow-sm">
      <h4 class="font-semibold text-amber-800 flex items-center gap-2">⚠️ ข้อควรระวัง</h4>
      <ul class="text-sm text-amber-700 mt-2 space-y-1">
       <li>• ห้ามย่อหน้าจอ พับหน้าจอ หรือเปิดหน้าต่างอื่น</li>
       <li>• ห้ามแคปหน้าจอ (Print Screen)</li>
       <li>• หากทุจริตครบ 3 ครั้ง จะถูกยุติการสอบทันที</li>
       <li class="font-bold text-red-600">• การสอบเป็นแบบเดินหน้าทางเดียว ไม่สามารถย้อนกลับมาแก้ข้อเดิมได้</li>
      </ul>
     </div>
    </div>
   </div>

   <!-- Exam Page -->
   <div id="exam-page" class="hidden max-w-4xl mx-auto px-4 py-6">
    <div class="bg-white rounded-2xl card-shadow p-4 md:p-6 mb-4">
     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
      <div>
       <h3 class="text-lg font-bold text-sky-800" id="student-info-display"></h3>
       <p class="text-sky-600 text-sm">ข้อสอบ: <span id="current-question-num">1</span>/<span id="total-questions-display">40</span></p>
      </div>
      <div id="warning-display" class="hidden bg-red-100 px-4 py-2 rounded-lg warning-pulse shadow-sm border border-red-200"><span class="text-red-600 font-semibold">⚠️ คำเตือน: <span id="warning-count">0</span>/3</span></div>
     </div>
     <div class="flex flex-wrap gap-2 mb-4 p-3 bg-sky-50 rounded-xl max-h-32 overflow-y-auto shadow-inner">
      <div id="question-nav" class="flex flex-wrap gap-2"></div>
     </div>
    </div>
    
    <div id="question-container" class="bg-white rounded-2xl card-shadow p-4 md:p-6 mb-6"></div>
    
    <div class="flex justify-between mt-4 gap-4">
        <button id="next-btn" onclick="confirmNextQuestion()" class="w-full btn-primary text-white font-semibold py-3 rounded-xl transition-all shadow-md hover:shadow-lg"> ข้อถัดไป → </button>
    </div>
    <button onclick="submitExam()" class="w-full mt-6 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all shadow-md"> ส่งข้อสอบ </button>
   </div>

   <!-- Result Page -->
   <div id="result-page" class="hidden max-w-lg mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl card-shadow p-6 md:p-8 text-center">
     <div id="result-icon" class="w-24 h-24 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg animate-bounce">
      <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
     </div>
     <h2 class="text-2xl font-bold text-gray-800 mb-2">ส่งข้อสอบเรียบร้อย!</h2>
     <p id="result-name" class="text-gray-600 mb-6"></p>
     <div class="bg-sky-50 rounded-xl p-6 mb-6 border border-sky-100 shadow-inner">
      <p class="text-5xl font-bold text-sky-600" id="result-score">0/0</p>
      <p class="text-sky-800 mt-2 font-medium">คะแนนที่ได้</p>
     </div>
     <p id="result-time" class="text-gray-500 font-medium"></p>
    </div>
   </div>

   <!-- Admin Page -->
   <div id="admin-page" class="hidden">
    <div class="flex h-full">
     <!-- Sidebar -->
     <div class="w-64 bg-white shadow-xl fixed h-full overflow-y-auto hidden md:block z-20 no-print">
      <div class="p-6 border-b bg-sky-50">
       <h3 class="font-bold text-sky-800 text-lg">แอดมินระบบ</h3>
       <p id="admin-email-display" class="text-sm text-gray-500 truncate"></p>
      </div>
      <nav class="p-4 space-y-2">
        <button onclick="showAdminTab('questions')" class="sidebar-item active w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium" data-tab="questions">
            <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            จัดการข้อสอบ
        </button> 
        <button onclick="showAdminTab('results')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium" data-tab="results">
            <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            ผลสอบ
        </button> 
        <button onclick="showAdminTab('students')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium" data-tab="students">
            <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            จัดการผู้สอบ
        </button> 
        <button onclick="showAdminTab('settings')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium" data-tab="settings">
            <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            ตั้งค่าเวลา
        </button>
       <div class="border-t mt-4 pt-4">
         <button onclick="adminLogout()" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-red-600 hover:bg-red-50 font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
            ออกจากระบบ
         </button>
       </div>
      </nav>
     </div>
     
     <!-- Mobile Menu -->
     <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow- z-50 border-t no-print">
      <div class="flex justify-around py-2">
        <button onclick="showAdminTab('questions')" class="flex flex-col items-center p-2 text-sky-600" data-tab-mobile="questions"><span class="text-xs font-medium">ข้อสอบ</span></button> 
        <button onclick="showAdminTab('results')" class="flex flex-col items-center p-2 text-gray-500" data-tab-mobile="results"><span class="text-xs font-medium">ผลสอบ</span></button> 
        <button onclick="showAdminTab('students')" class="flex flex-col items-center p-2 text-gray-500" data-tab-mobile="students"><span class="text-xs font-medium">ผู้สอบ</span></button> 
        <button onclick="showAdminTab('settings')" class="flex flex-col items-center p-2 text-gray-500" data-tab-mobile="settings"><span class="text-xs font-medium">เวลา</span></button> 
        <button onclick="adminLogout()" class="flex flex-col items-center p-2 text-red-500"><span class="text-xs font-medium">ออก</span></button>
      </div>
     </div>

     <!-- Main Content -->
     <div class="flex-1 md:ml-64 p-4 md:p-8 pb-24 md:pb-8">
      <!-- Questions Tab -->
      <div id="admin-questions" class="admin-content">
       <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold text-sky-800">จัดการข้อสอบ</h2>
        <div class="flex gap-2 flex-wrap">
            <button onclick="showAddQuestionModal()" class="btn-primary text-white px-4 py-2 rounded-xl flex items-center gap-2 shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>เพิ่มข้อสอบ</button> 
            <button onclick="showImportExcelModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-emerald-600 transition-all shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>นำเข้า Excel</button>
            <button onclick="confirmCreateDefaultQuestions()" class="bg-amber-500 text-white px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-amber-600 transition-all shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>รีเซ็ตข้อสอบ</button>
        </div>
       </div>
       <div id="questions-list" class="space-y-4"></div>
      </div>

      <!-- Results Tab -->
      <div id="admin-results" class="admin-content hidden">
       <div class="flex flex-wrap justify-between items-center gap-4 mb-6 no-print">
        <h2 class="text-2xl font-bold text-sky-800">ผลการสอบ</h2>
        <div class="flex gap-2">
            <button onclick="refreshResults()" class="bg-sky-100 text-sky-600 px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-sky-200 transition-all border border-sky-200">รีเฟรช</button>
            <button onclick="exportExcel()" class="bg-emerald-500 text-white px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-emerald-600 transition-all shadow-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Excel
            </button>
            <button onclick="printReport()" class="bg-gray-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-gray-700 transition-all shadow-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                พิมพ์ / PDF
            </button>
        </div>
       </div>

       <!-- Filters Row -->
       <div class="flex gap-4 mb-4 flex-wrap no-print">
         <div class="flex-1 min-w-">
           <input type="text" id="search-results" oninput="filterResults()" placeholder="ค้นหาชื่อหรือเลขที่..." class="w-full px-4 py-2 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none transition-all">
         </div>
         <div class="w-full md:w-48">
           <select id="filter-classroom" onchange="filterResults()" class="w-full px-4 py-2 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none transition-all">
             <option value="">ทุกห้อง</option>
             <option value="ม.6/6">ม.6/6</option>
             <option value="ม.6/7">ม.6/7</option>
             <option value="ม.6/8">ม.6/8</option>
             <option value="ม.6/9">ม.6/9</option>
             <option value="ม.6/10">ม.6/10</option>
             <option value="ม.6/11">ม.6/11</option>
           </select>
         </div>
       </div>
       
       <!-- Print Header (Hidden on Screen) -->
       <div id="print-header" class="hidden">
           <div class="flex items-center gap-4 justify-center mb-4">
             <div class="w-16 h-16 bg-sky-600 rounded-lg flex items-center justify-center">
               <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
             </div>
             <div class="text-left">
               <h1 class="text-2xl font-bold text-sky-800">รายงานผลคะแนนสอบปลายภาค</h1>
               <p class="text-gray-600 font-semibold">รายวิชา ชีววิทยา 6 (ว33246)</p>
               <p class="text-sm text-gray-500" id="print-subtitle"></p>
             </div>
           </div>
       </div>

       <div id="results-list" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100">
        <div class="overflow-x-auto" id="print-area">
         <table class="w-full">
          <thead class="bg-sky-50 border-b border-sky-100">
           <tr>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800 w-16">ลำดับ</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">ชื่อ-สกุล</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800 w-20">เลขที่</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800 w-24">ห้อง</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800 w-24">คะแนน</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800 w-32">เวลา</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">สถานะ</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800 no-print w-20">จัดการ</th>
           </tr>
          </thead>
          <tbody id="results-tbody" class="divide-y divide-gray-100"></tbody>
         </table>
        </div>
       </div>

       <!-- Signature Footer (Hidden on Screen) -->
       <div id="print-footer" class="hidden justify-between mt-10 pt-10 px-10">
           <div class="text-center">
               <div class="mb-8">ลงชื่อ......................................................</div>
               <div>(ว่าที่ร้อยตรีอานนท์ เมืองแก้ว)</div>
               <div class="text-sm text-gray-500 mt-1">ครูผู้สอน</div>
           </div>
           <div class="text-center">
               <div class="mb-8">ลงชื่อ......................................................</div>
               <div>(......................................................)</div>
               <div class="text-sm text-gray-500 mt-1">หัวหน้ากลุ่มสาระฯ / วิชาการ</div>
           </div>
       </div>
      </div>

      <!-- Students Tab -->
      <div id="admin-students" class="admin-content hidden">
       <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold text-sky-800">จัดการผู้สอบ</h2>
        <button onclick="refreshStudents()" class="bg-sky-100 text-sky-600 px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-sky-200 transition-all border border-sky-200">รีเฟรช</button>
       </div>
       <div class="bg-white rounded-xl p-4 mb-4 shadow-sm border border-gray-100"><input type="text" id="search-students" oninput="searchStudents()" placeholder="ค้นหาชื่อหรือเลขที่..." class="w-full px-4 py-2 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none transition-all"></div>
       <div id="students-list" class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100">
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-sky-50 border-b border-sky-100">
           <tr>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">ลำดับ</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">ชื่อ-สกุล</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">เลขที่</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">ห้อง</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">สถานะ</th>
            <th class="px-4 py-3 text-left text-sm font-bold text-sky-800">จัดการ</th>
           </tr>
          </thead>
          <tbody id="students-tbody" class="divide-y divide-gray-100"></tbody>
         </table>
        </div>
       </div>
      </div>

      <!-- Settings Tab -->
      <div id="admin-settings" class="admin-content hidden">
       <h2 class="text-2xl font-bold text-sky-800 mb-6">ตั้งค่าเวลาสอบ</h2>
       <div class="bg-white rounded-xl p-6 max-w-md shadow-sm border border-gray-100">
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">เวลาสอบ (นาที)</label> <input type="number" id="exam-time" value="60" min="1" class="w-full px-4 py-3 border border-sky-200 rounded-xl focus:ring-2 focus:ring-sky-400 outline-none transition-all"></div>
         <div class="flex items-center gap-3"><input type="checkbox" id="enable-timer" class="w-5 h-5 text-sky-600 rounded"> <label for="enable-timer" class="text-gray-700">เปิดใช้งานจับเวลา</label></div>
         <button onclick="saveTimerSettings()" class="w-full btn-primary text-white py-3 rounded-xl shadow-md"> บันทึกการตั้งค่า </button>
        </div>
       </div>
      </div>

     </div>
    </div>
   </div>
  </div>

  <script>
    // --------------------------------------------------------
    // Firebase Configuration
    // --------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyABrzk3SHN0lVpBY97xDQZdUgOKREb89aQ",
      authDomain: "test-biology-47fcc.firebaseapp.com",
      projectId: "test-biology-47fcc",
      storageBucket: "test-biology-47fcc.firebasestorage.app",
      messagingSenderId: "758750642719",
      appId: "1:758750642719:web:d4d70897d1839886d9cb2a",
      measurementId: "G-VTGK8GY9DK"
    };

    // Initialize Firebase
    let auth, db;
    try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
    } catch (e) {
        console.error("Firebase Error:", e);
        Swal.fire("ข้อผิดพลาด", "ไม่สามารถเชื่อมต่อฐานข้อมูลได้", "error");
    }

    // --------------------------------------------------------
    // Global State
    // --------------------------------------------------------
    let currentUser = null;
    let isAdmin = false;
    let questions =[];
    let currentQuestionIndex = 0;
    let studentAnswers = {};
    let studentInfo = { name: '', number: '', classroom: '' };
    let currentStudentDocId = null;
    let warningCount = 0;
    let examTimer = null;
    let examTimeLeft = 0;
    let examStartTime = null;
    let timerSettings = { enabled: false, minutes: 60 };
    let allResults = [];
    let allStudents =[];
    let isAway = false;
    let lastCheatTime = 0;
    
    // Cache for filtering
    let filteredResults =[];

    // --------------------------------------------------------
    // Core Functions
    // --------------------------------------------------------
    async function loadQuestions() {
      try {
        const snapshot = await db.collection('questions').orderBy('order').get();
        questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if(questions.length > 0) document.getElementById('total-questions-display').textContent = questions.length;
      } catch (error) { console.error('Error loading questions:', error); }
    }

    // ฟังก์ชันสำหรับสลับลำดับข้อสอบ (Shuffle)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));, array] =, array];
        }
        return array;
    }

    function generateDefaultQuestions() {
        const topics =[
            { q: 'ระบบนิเวศคืออะไร', choices:, answer: 0 },
            { q: 'ผู้ผลิตในระบบนิเวศคือใคร', choices:, answer: 0 },
            { q: 'การสังเคราะห์แสงได้แก๊สอะไร', choices:, answer: 0 }
        ];
        let fullList =[];
        for(let i=0; i<40; i++) {
            if(i < topics.length) fullList.push(topics);
            else fullList.push({ q: `ข้อสอบตัวอย่างข้อที่ ${i+1}`, choices:, answer: 0 });
        }
        return fullList.map((t, i) => ({
            id: `q${i + 1}`,
            order: i + 1,
            question: `${i + 1}. ${t.q}`,
            choices: t.choices,
            correctAnswer: t.answer
        }));
    }

    async function createDefaultQuestions() {
        const defaultQuestions = generateDefaultQuestions();
        const batch = db.batch();
        try {
            const snapshot = await db.collection('questions').get();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        } catch(e) {}

        const newBatch = db.batch();
        defaultQuestions.forEach(q => {
            const docRef = db.collection('questions').doc(q.id);
            newBatch.set(docRef, q);
        });
        await newBatch.commit();
        questions = defaultQuestions;
    }

    // --------------------------------------------------------
    // Student Exam Flow
    // --------------------------------------------------------
    document.getElementById('registration-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('student-name').value.trim();
        const number = document.getElementById('student-number').value.trim();
        const classroom = document.getElementById('student-classroom').value.trim();
        
        if (!name || !number || !classroom) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
        
        studentInfo = { name, number, classroom };
        
        try {
            // ค้นหาตามเลขที่ก่อน
            const checkQuery = await db.collection('students').where('number', '==', number).get();
            
            // ใช้ JavaScript กรองหาคนที่มี "เลขที่" และ "ห้อง" ตรงกัน
            let existingDoc = null;
            checkQuery.forEach(doc => {
                if (doc.data().classroom === classroom) {
                    existingDoc = doc;
                }
            });

            if (existingDoc) {
                // เจอคนเดิม (เลขที่เดิม ห้องเดิม) -> อนุญาตให้สอบใหม่ได้ (อัปเดตสถานะกลับเป็นกำลังสอบ)
                currentStudentDocId = existingDoc.id;
                await db.collection('students').doc(currentStudentDocId).update({ 
                    name: name, // อัปเดตชื่อเผื่อแก้คำผิด
                    startTime: firebase.firestore.FieldValue.serverTimestamp(), 
                    status: 'กำลังสอบ' 
                });
            } else {
                // ไม่เจอ -> สร้างใหม่
                const doc = await db.collection('students').add({ 
                    ...studentInfo, 
                    startTime: firebase.firestore.FieldValue.serverTimestamp(), 
                    status: 'กำลังสอบ' 
                });
                currentStudentDocId = doc.id;
            }
            
            await loadQuestions();
            if(questions.length === 0) {
                Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อสอบในระบบ กรุณาแจ้งผู้คุมสอบ', 'error');
            } else {
                startExam();
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
        }
    });

    function startExam() {
        document.getElementById('registration-page').classList.add('hidden');
        document.getElementById('exam-page').classList.remove('hidden');
        document.getElementById('timer-display').classList.remove('hidden');
        document.getElementById('student-info-display').textContent = `${studentInfo.name} (เลขที่ ${studentInfo.number})`;
        
        // สุ่มลำดับข้อสอบก่อนเริ่ม (ทุกคนจะได้ลำดับข้อไม่เหมือนกัน)
        questions = shuffleArray(questions);

        // --- ตัดสุ่มเอาแค่ 30 ข้อ ---
        const maxQuestions = 30; // ระบุจำนวนข้อที่ต้องการให้สอบตรงนี้
        if (questions.length > maxQuestions) {
            questions = questions.slice(0, maxQuestions);
        }
        document.getElementById('total-questions-display').textContent = questions.length;
        // -----------------------

        examStartTime = Date.now();
        loadTimerSettings();
        setupAntiCheat();
        renderQuestionNav();
        renderQuestion();
        updateNextButtonState(); 
    }

    // --------------------------------------------------------
    // Anti-Cheat (Combined & Debounced)
    // --------------------------------------------------------
    function setupAntiCheat() {
        // 1. Visibility (Tab switching/Minimizing)
        document.addEventListener('visibilitychange', () => {
            if(document.hidden) triggerPenalty('ตรวจพบการพับหน้าจอ/สลับแท็บ');
            // Remove 'isAway = false' from here, let the popup handle it
        });

        // 2. Blur (Clicking outside/Overlay tools)
        window.addEventListener('blur', () => triggerPenalty('ตรวจพบการออกนอกหน้าจอ'));
        // Remove 'focus' listener that resets isAway immediately
        // window.addEventListener('focus', () => isAway = false); 

        // 3. PrintScreen Key
        window.addEventListener('keyup', (e) => {
            if(e.key === 'PrintScreen' || e.keyCode === 44) triggerPenalty('ตรวจพบการแคปหน้าจอ');
        });
        
        // 4. Context Menu
        document.addEventListener('contextmenu', (e) => e.preventDefault());
    }

    function triggerPenalty(reason) {
        if(isAdmin || document.getElementById('exam-page').classList.contains('hidden')) return;
        
        const now = Date.now();
        if(isAway || (now - lastCheatTime < 1000)) return; // Cooldown 1s
        
        isAway = true;
        lastCheatTime = now;
        warningCount++;

        document.getElementById('warning-display').classList.remove('hidden');
        document.getElementById('warning-count').textContent = warningCount;

        if(warningCount >= 3) {
            terminateExam();
        } else {
            Swal.fire({
                icon: 'warning',
                title: `คำเตือนครั้งที่ ${warningCount}`,
                html: `<b>${reason}</b><br>ห้ามพับหน้าจอ, เปิดแท็บอื่น หรือแคปหน้าจอ<br>หากครบ 3 ครั้ง จะถูกยุติการสอบทันที`,
                confirmButtonColor: '#f59e0b',
                allowOutsideClick: false // Prevent closing by clicking outside
            }).then(() => {
                isAway = false; // Reset away status ONLY after they click OK
            });
        }
    }

    function terminateExam() {
        clearInterval(examTimer);
        Swal.fire({
            icon: 'error',
            title: 'ยุติการสอบ',
            text: 'คุณทำผิดกฎครบ 3 ครั้ง',
            confirmButtonColor: '#ef4444',
            allowOutsideClick: false
        }).then(() => submitExamData(true));
    }

    // --------------------------------------------------------
    // Timer
    // --------------------------------------------------------
    async function loadTimerSettings() {
        try {
            const doc = await db.collection('settings').doc('timer').get();
            if (doc.exists) timerSettings = doc.data();
        } catch (e) {}
        
        if (timerSettings.enabled) {
            examTimeLeft = timerSettings.minutes * 60;
            updateTimerDisplay();
            examTimer = setInterval(() => {
                examTimeLeft--;
                updateTimerDisplay();
                if (examTimeLeft <= 0) { clearInterval(examTimer); autoSubmitExam(); }
            }, 1000);
        } else {
            examTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
                const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
                const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
                const s = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer-text').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }
    }

    function updateTimerDisplay() {
        const h = Math.floor(examTimeLeft / 3600).toString().padStart(2, '0');
        const m = Math.floor((examTimeLeft % 3600) / 60).toString().padStart(2, '0');
        const s = (examTimeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer-text').textContent = `${h}:${m}:${s}`;
        if(examTimeLeft <= 300) {
            document.getElementById('timer-display').classList.add('bg-red-100');
            document.getElementById('timer-text').classList.add('text-red-600');
        }
    }

    // --------------------------------------------------------
    // Render & Navigation (MODIFIED: Random + One-way)
    // --------------------------------------------------------
    function renderQuestionNav() {
        const nav = document.getElementById('question-nav');
        nav.innerHTML = questions.map((q, i) => {
            // Logic: Determine styles but REMOVE click capability
            let styles = "w-8 h-8 rounded-lg text-sm font-medium transition-all flex items-center justify-center cursor-default ";
            
            if (i === currentQuestionIndex) {
                styles += "bg-sky-500 text-white shadow-md"; // ปัจจุบัน
            } else if (i < currentQuestionIndex) {
                styles += "bg-gray-200 text-gray-400"; // ผ่านไปแล้ว (สีจาง)
            } else {
                styles += "bg-white border border-sky-200 text-sky-600 opacity-50"; // อนาคต
            }
            
            return `<div class="${styles}">${i + 1}</div>`;
        }).join('');
    }

    function renderQuestion() {
        const q = questions;
        if(!q) return;

        // ตัดเลขข้อเก่าออกจากโจทย์ (เช่น "5. โจทย์" เหลือ "โจทย์") เพื่อใส่เลขใหม่ตามลำดับการสุ่ม
        const cleanQuestion = q.question.replace(/^\d++\s*/, '');

        const container = document.getElementById('question-container');
        container.innerHTML = `
            <div class="question-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">${currentQuestionIndex + 1}. ${cleanQuestion}</h3>
                <div class="space-y-3">
                    ${q.choices.map((c, i) => `
                        <label class="flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${studentAnswers === i ? 'border-sky-500 bg-sky-50 ring-1 ring-sky-200' : 'border-gray-200 hover:border-sky-300'}">
                            <input type="radio" name="answer" value="${i}" ${studentAnswers === i ? 'checked' : ''} onchange="selectAnswer(${i})" class="w-5 h-5 text-sky-600 focus:ring-sky-500">
                            <span class="ml-3 text-gray-700"><span class="font-bold mr-1">${i+1}.</span> ${c}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
        document.getElementById('current-question-num').textContent = currentQuestionIndex + 1;
        renderQuestionNav();
        updateNextButtonState();

        // ซ่อนปุ่มข้อถัดไปถ้าเป็นข้อสุดท้าย
        const nextBtn = document.getElementById('next-btn');
        if (currentQuestionIndex === questions.length - 1) {
            nextBtn.style.display = 'none';
        } else {
            nextBtn.style.display = 'block';
        }
    }

    function selectAnswer(i) {
        studentAnswers.id] = i;
        renderQuestionNav();
        updateNextButtonState();
    }

    function updateNextButtonState() {
        const btn = document.getElementById('next-btn');
        if(studentAnswers.id] === undefined) {
            btn.classList.add('btn-disabled');
            btn.classList.remove('btn-primary', 'hover:shadow-lg');
            btn.disabled = true;
        } else {
            btn.classList.remove('btn-disabled');
            btn.classList.add('btn-primary', 'hover:shadow-lg');
            btn.disabled = false;
        }
    }

    // New Function: Confirm before next question
    function confirmNextQuestion() {
        if(studentAnswers.id] === undefined) return;

        Swal.fire({
            title: 'ยืนยันคำตอบ?',
            text: "เมื่อผ่านข้อนี้ไปแล้ว จะไม่สามารถย้อนกลับมาแก้ไขได้อีก",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#0ea5e9',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ยืนยันและไปต่อ',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                if(currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    renderQuestion();
                }
            }
        });
    }

    function submitExam() {
        const answered = Object.keys(studentAnswers).length;
        Swal.fire({
            title: 'ยืนยันส่งข้อสอบ?',
            html: `ตอบแล้ว ${answered}/${questions.length} ข้อ`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ส่งข้อสอบ',
            confirmButtonColor: '#10b981'
        }).then((res) => { if(res.isConfirmed) submitExamData(); });
    }

    function autoSubmitExam() {
        Swal.fire('หมดเวลาสอบ', 'ระบบกำลังส่งคำตอบอัตโนมัติ', 'warning').then(() => submitExamData());
    }

    async function submitExamData(cheated = false) {
        clearInterval(examTimer);
        let score = 0;
        questions.forEach(q => { if(studentAnswers === q.correctAnswer) score++; });
        
        const duration = Math.floor((Date.now() - examStartTime) / 1000);
        const durationStr = `${Math.floor(duration/60)} นาที ${duration%60} วินาที`;
        const status = cheated ? 'ถูกยุติการสอบ' : 'ส่งแล้ว';

        if(currentStudentDocId) await db.collection('students').doc(currentStudentDocId).update({ status });

        await db.collection('results').add({
            ...studentInfo, score, totalQuestions: questions.length, answers: studentAnswers,
            duration: durationStr, durationSeconds: duration, warnings: warningCount, cheated, status,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('exam-page').classList.add('hidden');
        document.getElementById('timer-display').classList.add('hidden');
        document.getElementById('result-page').classList.remove('hidden');
        
        if(cheated) {
            document.getElementById('result-icon').innerHTML = `<svg class="w-12 h-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`;
            document.getElementById('result-icon').className = 'w-24 h-24 bg-gradient-to-br from-red-400 to-red-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg';
        }
        
        document.getElementById('result-name').textContent = `${studentInfo.name} (${studentInfo.classroom})`;
        document.getElementById('result-score').textContent = `${score}/${questions.length}`;
        document.getElementById('result-time').textContent = `เวลาที่ใช้: ${durationStr}`;
    }

    // --------------------------------------------------------
    // Admin Functions
    // --------------------------------------------------------
    function showAdminLogin() {
        if(isAdmin) return showAdminPage();
        Swal.fire({
            title: 'เข้าสู่ระบบแอดมิน',
            html: '<input id="swal-email" class="swal2-input" placeholder="Email"><input id="swal-pass" type="password" class="swal2-input" placeholder="Password">',
            showCancelButton: true,
            confirmButtonText: 'เข้าสู่ระบบ',
            confirmButtonColor: '#0ea5e9',
            preConfirm: () => ({ email: document.getElementById('swal-email').value, pass: document.getElementById('swal-pass').value })
        }).then(async (res) => {
            if(res.isConfirmed) {
                try {
                    const user = await auth.signInWithEmailAndPassword(res.value.email, res.value.pass);
                    currentUser = user.user;
                    isAdmin = true;
                    showAdminPage();
                } catch(e) { Swal.fire('Error', 'รหัสผ่านไม่ถูกต้อง', 'error'); }
            }
        });
    }

    function showAdminPage() {
        document.getElementById('registration-page').classList.add('hidden');
        document.getElementById('admin-page').classList.remove('hidden');
        document.getElementById('admin-email-display').textContent = currentUser?.email;
        loadAdminData();
    }

    async function loadAdminData() {
        await loadQuestions();
        await loadResults();
        await loadStudents();
        renderQuestionsAdmin();
    }

    function showAdminTab(tab) {
        document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`admin-${tab}`).classList.remove('hidden');
        document.querySelectorAll('.sidebar-item').forEach(el => {
            el.classList.remove('active');
            if(el.dataset.tab === tab) el.classList.add('active');
        });
        document.querySelectorAll('').forEach(el => {
            el.classList.remove('text-sky-600');
            el.classList.add('text-gray-500');
            if(el.dataset.tabMobile === tab) { el.classList.add('text-sky-600'); el.classList.remove('text-gray-500'); }
        });
    }

    function renderQuestionsAdmin() {
        const container = document.getElementById('questions-list');
        container.innerHTML = questions.map(q => `
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex justify-between items-start gap-4">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-800">${q.question}</h4>
                    <div class="mt-2 text-sm text-gray-600 ml-4 space-y-1">
                        ${q.choices.map((c, i) => `<div class="${i===q.correctAnswer ? 'text-emerald-600 font-bold' : ''}">${i+1}. ${c}</div>`).join('')}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="editQuestion('${q.id}')" class="p-2 bg-sky-100 text-sky-600 rounded-lg hover:bg-sky-200 transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                    <button onclick="deleteQuestion('${q.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                </div>
            </div>
        `).join('');
    }

    function confirmCreateDefaultQuestions() {
        Swal.fire({
            title: 'ยืนยันรีเซ็ต?',
            text: "ข้อสอบเก่าจะถูกลบและแทนที่ด้วยข้อสอบตัวอย่าง 40 ข้อ",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f59e0b',
            confirmButtonText: 'ยืนยัน'
        }).then(async (res) => {
            if(res.isConfirmed) {
                Swal.fire({title:'กำลังดำเนินการ...', didOpen: () => Swal.showLoading()});
                await createDefaultQuestions();
                renderQuestionsAdmin();
                Swal.fire('สำเร็จ', 'รีเซ็ตข้อสอบเรียบร้อย', 'success');
            }
        });
    }

    async function adminLogout() { await auth.signOut(); location.reload(); }
    
    // Explicit Success Popup for Delete Question
    async function deleteQuestion(id) {
        if((await Swal.fire({title:'ยืนยันการลบ?',text:'ไม่สามารถกู้คืนได้',icon:'warning',showCancelButton:true,confirmButtonColor:'#ef4444'})).isConfirmed) {
            await db.collection('questions').doc(id).delete();
            questions = questions.filter(q => q.id !== id);
            renderQuestionsAdmin();
            await Swal.fire('ลบสำเร็จ', 'ลบข้อสอบเรียบร้อยแล้ว', 'success');
        }
    }

    // Helper Modals
    function showAddQuestionModal() {
        Swal.fire({
            title: 'เพิ่มข้อสอบ',
            html: `<div class="text-left space-y-3">
                   <input id="nq" class="w-full px-3 py-2 border rounded-lg" placeholder="คำถาม">
                   <input id="c1" class="w-full px-3 py-2 border rounded-lg" placeholder="ตัวเลือก 1">
                   <input id="c2" class="w-full px-3 py-2 border rounded-lg" placeholder="ตัวเลือก 2">
                   <input id="c3" class="w-full px-3 py-2 border rounded-lg" placeholder="ตัวเลือก 3">
                   <input id="c4" class="w-full px-3 py-2 border rounded-lg" placeholder="ตัวเลือก 4">
                   <select id="ca" class="w-full px-3 py-2 border rounded-lg"><option value="0">ตอบ 1</option><option value="1">ตอบ 2</option><option value="2">ตอบ 3</option><option value="3">ตอบ 4</option></select></div>`,
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            confirmButtonColor: '#0ea5e9',
            preConfirm: () => ({ q: document.getElementById('nq').value, choices:, a: parseInt(document.getElementById('ca').value) })
        }).then(async (res) => {
            if(res.isConfirmed) {
                await db.collection('questions').add({ order: questions.length+1, question: res.value.q, choices: res.value.choices, correctAnswer: res.value.a });
                loadAdminData();
                await Swal.fire('บันทึกสำเร็จ', 'เพิ่มข้อสอบเรียบร้อยแล้ว', 'success');
            }
        });
    }

    function editQuestion(id) {
        const q = questions.find(x => x.id === id);
        if(!q) return;
        
        Swal.fire({
            title: 'แก้ไขข้อสอบ',
            html: `<div class="text-left space-y-3">
                   <input id="nq" class="w-full px-3 py-2 border rounded-lg" value="${q.question.replace(/^\d+\.\s*/,'')}">
                   <input id="c1" class="w-full px-3 py-2 border rounded-lg" value="${q.choices}">
                   <input id="c2" class="w-full px-3 py-2 border rounded-lg" value="${q.choices}">
                   <input id="c3" class="w-full px-3 py-2 border rounded-lg" value="${q.choices}">
                   <input id="c4" class="w-full px-3 py-2 border rounded-lg" value="${q.choices}">
                   <select id="ca" class="w-full px-3 py-2 border rounded-lg">
                    <option value="0" ${q.correctAnswer==0?'selected':''}>1</option>
                    <option value="1" ${q.correctAnswer==1?'selected':''}>2</option>
                    <option value="2" ${q.correctAnswer==2?'selected':''}>3</option>
                    <option value="3" ${q.correctAnswer==3?'selected':''}>4</option>
                   </select></div>`,
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            confirmButtonColor: '#0ea5e9',
            preConfirm: () => ({ q: document.getElementById('nq').value, choices:, a: parseInt(document.getElementById('ca').value) })
        }).then(async (res) => {
            if(res.isConfirmed) {
                await db.collection('questions').doc(id).update({ question: `${q.order}. ${res.value.q}`, choices: res.value.choices, correctAnswer: res.value.a });
                loadAdminData();
                await Swal.fire('บันทึกสำเร็จ', 'แก้ไขข้อสอบเรียบร้อยแล้ว', 'success');
            }
        });
    }

    function showImportExcelModal() {
        Swal.fire({
            title: 'Import Excel',
            html: '<p class="text-sm text-gray-500 mb-2">A=คำถาม, B-E=ตัวเลือก, F=เฉลย(0-3)</p><input type="file" id="xls" accept=".xlsx" class="w-full border rounded-lg p-2">',
            showCancelButton: true,
            confirmButtonText: 'นำเข้า',
            confirmButtonColor: '#0ea5e9',
            preConfirm: () => document.getElementById('xls').files
        }).then((res) => {
            if(res.isConfirmed && res.value) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const wb = XLSX.read(e.target.result, {type:'binary'});
                    const data = XLSX.utils.sheet_to_json(wb.Sheets], {header:'A'});
                    if((await Swal.fire({title:'ยืนยัน?',text:'ข้อสอบเก่าจะถูกลบทั้งหมด',icon:'warning',showCancelButton:true})).isConfirmed) {
                        const batch = db.batch();
                        questions.forEach(q => batch.delete(db.collection('questions').doc(q.id)));
                        const newBatch = db.batch();
                        let idx = 1;
                        data.forEach(r => {
                            if(r.A && r.B && r.C && r.D && r.E && r.F!==undefined) {
                                newBatch.set(db.collection('questions').doc(`q${idx}`), { order: idx++, question: r.A, choices:, correctAnswer: parseInt(r.F) });
                            }
                        });
                        await batch.commit(); await newBatch.commit();
                        loadAdminData();
                        Swal.fire('สำเร็จ', `นำเข้า ${idx-1} ข้อ`, 'success');
                    }
                };
                reader.readAsBinaryString(res.value);
            }
        });
    }

    // --------------------------------------------------------------------------------
    // Results Management (Updated for Filtering and Exporting)
    // --------------------------------------------------------------------------------
    async function loadResults() {
        const snap = await db.collection('results').orderBy('submittedAt', 'desc').get();
        allResults = snap.docs.map(d => ({id: d.id, ...d.data()}));
        filterResults(); // Initial render
    }

    function filterResults() {
        const searchText = document.getElementById('search-results').value.toLowerCase();
        const classFilter = document.getElementById('filter-classroom').value;

        filteredResults = allResults.filter(r => {
            const matchesText = r.name.toLowerCase().includes(searchText) || r.number.toString().includes(searchText);
            const matchesClass = classFilter === "" || r.classroom === classFilter;
            return matchesText && matchesClass;
        });

        renderResultsTable(filteredResults);
    }

    function renderResultsTable(data) {
        document.getElementById('results-tbody').innerHTML = data.map((r, i) => `
            <tr class="hover:bg-sky-50">
                <td class="px-4 py-3 border-gray-200">${i+1}</td>
                <td class="px-4 py-3 font-medium border-gray-200">${r.name}</td>
                <td class="px-4 py-3 border-gray-200">${r.number}</td>
                <td class="px-4 py-3 border-gray-200">${r.classroom}</td>
                <td class="px-4 py-3 border-gray-200"><span class="px-2 py-1 rounded-full text-xs font-bold ${r.score >= r.totalQuestions/2 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${r.score}/${r.totalQuestions}</span></td>
                <td class="px-4 py-3 text-sm border-gray-200">${r.duration}</td>
                <td class="px-4 py-3 border-gray-200"><span class="px-2 py-1 rounded-full text-xs whitespace-nowrap ${r.cheated ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">${r.status}</span></td>
                <td class="px-4 py-3 border-gray-200 no-print"><button onclick="deleteResult('${r.id}')" class="p-2 bg-red-50 text-red-600 rounded hover:bg-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
            </tr>`).join('');
    }

    async function loadStudents() {
        const snap = await db.collection('students').orderBy('startTime', 'desc').get();
        allStudents = snap.docs.map(d => ({id: d.id, ...d.data()}));
        document.getElementById('students-tbody').innerHTML = allStudents.map((s, i) => {
            let color = 'bg-amber-100 text-amber-700';
            if(s.status === 'ส่งแล้ว') color = 'bg-emerald-100 text-emerald-700';
            if(s.status === 'ถูกยุติการสอบ') color = 'bg-red-100 text-red-700';
            return `
            <tr class="hover:bg-sky-50">
                <td class="px-4 py-3">${i+1}</td>
                <td class="px-4 py-3 font-medium">${s.name}</td>
                <td class="px-4 py-3">${s.number}</td>
                <td class="px-4 py-3">${s.classroom}</td>
                <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs whitespace-nowrap ${color}">${s.status}</span></td>
                <td class="px-4 py-3"><button onclick="deleteStudent('${s.id}')" class="p-2 bg-red-50 text-red-600 rounded hover:bg-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
            </tr>`;
        }).join('');
    }

    // Explicit Success Popup for Delete Result
    async function deleteResult(id) {
        if((await Swal.fire({title:'ลบผลสอบ?',icon:'warning',showCancelButton:true})).isConfirmed) {
            await db.collection('results').doc(id).delete();
            loadResults();
            await Swal.fire('ลบสำเร็จ', 'ลบผลสอบเรียบร้อยแล้ว', 'success');
        }
    }

    // Explicit Success Popup for Delete Student
    async function deleteStudent(id) {
        if((await Swal.fire({title:'ลบผู้สอบ?',text:'จะทำให้เข้าสอบใหม่ได้',icon:'warning',showCancelButton:true})).isConfirmed) {
            await db.collection('students').doc(id).delete();
            loadStudents();
            await Swal.fire('ลบสำเร็จ', 'ลบผู้เข้าสอบเรียบร้อยแล้ว', 'success');
        }
    }

    function saveTimerSettings() {
        const m = parseInt(document.getElementById('exam-time').value);
        const e = document.getElementById('enable-timer').checked;
        db.collection('settings').doc('timer').set({minutes: m, enabled: e});
        Swal.fire('บันทึกสำเร็จ', 'ตั้งค่าเวลาเรียบร้อยแล้ว', 'success');
    }

    async function loadTimerSettingsAdmin() {
        try {
            const doc = await db.collection('settings').doc('timer').get();
            if(doc.exists) {
                document.getElementById('exam-time').value = doc.data().minutes;
                document.getElementById('enable-timer').checked = doc.data().enabled;
            }
        } catch(e) {}
    }

    // Old Search function replaced by filterResults
    function searchResults() { filterResults(); }

    function searchStudents() {
        const q = document.getElementById('search-students').value.toLowerCase();
        const filtered = allStudents.filter(s => s.name.toLowerCase().includes(q) || s.number.toString().includes(q));
        const tbody = document.getElementById('students-tbody');
        tbody.innerHTML = filtered.map((s, i) => {
            let color = 'bg-amber-100 text-amber-700';
            if(s.status === 'ส่งแล้ว') color = 'bg-emerald-100 text-emerald-700';
            if(s.status === 'ถูกยุติการสอบ') color = 'bg-red-100 text-red-700';
            return `<tr class="hover:bg-sky-50"><td class="px-4 py-3">${i+1}</td><td class="px-4 py-3 font-medium">${s.name}</td><td class="px-4 py-3">${s.number}</td><td class="px-4 py-3">${s.classroom}</td><td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs whitespace-nowrap ${color}">${s.status}</span></td><td class="px-4 py-3"><button onclick="deleteStudent('${s.id}')" class="p-2 bg-red-50 text-red-600 rounded hover:bg-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td></tr>`;
        }).join('');
    }

    function refreshResults() {
        loadResults();
        Swal.fire({ icon: 'success', title: 'รีเฟรชสำเร็จ', timer: 1000, showConfirmButton: false });
    }

    function refreshStudents() {
        loadStudents();
        Swal.fire({ icon: 'success', title: 'รีเฟรชสำเร็จ', timer: 1000, showConfirmButton: false });
    }

    function exportExcel() {
        if(filteredResults.length === 0) return Swal.fire('ไม่มีข้อมูล', 'กรุณาเลือกช่วงข้อมูลที่มีผลสอบ', 'info');
        
        // Transform data for Excel
        const excelData = filteredResults.map((r, i) => ({
            'ลำดับ': i + 1,
            'ชื่อ-สกุล': r.name,
            'เลขที่': parseInt(r.number), // Ensure number format
            'ห้อง': r.classroom,
            'คะแนนที่ได้': r.score,
            'คะแนนเต็ม': r.totalQuestions,
            'เวลาที่ใช้': r.duration,
            'สถานะ': r.status,
            'เตือนทุจริต(ครั้ง)': r.warnings
        }));

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);
        XLSX.utils.book_append_sheet(wb, ws, "Results");
        
        // Generate filename with timestamp and class filter
        const classStr = document.getElementById('filter-classroom').value || 'All';
        XLSX.writeFile(wb, `Score_Bio6_${classStr}_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function printReport() {
        const classFilter = document.getElementById('filter-classroom').value;
        const subtitle = classFilter ? `ห้อง: ${classFilter}` : 'รายงานรวมทุกห้องเรียน';
        document.getElementById('print-subtitle').textContent = subtitle + ` (ข้อมูล ณ วันที่ ${new Date().toLocaleDateString('th-TH')})`;
        
        // Trigger Print (User can choose "Save as PDF" in the browser print dialog)
        window.print();
    }

    // Init
    if (typeof applyConfig === 'function') {
        applyConfig();
    }
  </script>
 </body>
</html>
